# API Key 模块命名评估文档

## 📋 文档信息

- **评估日期**: 2024年
- **评估主题**: 是否将 `api-key` 模块重命名为 `auth`
- **评估目的**: 记录命名决策的评估过程和结论，作为未来参考

## 🎯 评估背景

在开发过程中，曾考虑是否将 `api-key` 模块重命名为更通用的 `auth` 名称，以提升模块的通用性和可扩展性。本文档记录了详细的评估过程和最终建议。

## 📊 当前架构

### 目录结构

```
libs/infra/guard/
├── src/lib/
│   ├── api-key/                    # API Key 认证模块（子目录）
│   │   ├── api-key.module.ts       # ApiKeyModule
│   │   ├── api-key.guard.ts        # ApiKeyGuard
│   │   ├── api-key.constants.ts    # 服务注入令牌
│   │   ├── api-key.signature.algorithm.ts  # 签名算法枚举
│   │   ├── events/                 # 验证事件
│   │   │   └── api-key-validation.event.ts
│   │   ├── services/              # 验证服务
│   │   │   ├── api-key.interface.ts
│   │   │   ├── simple-api-key.service.ts
│   │   │   └── complex-api-key.service.ts
│   │   └── README.md              # 模块文档
│   └── jwt.auth.guard.ts           # JWT 认证守卫（直接在 lib 下）
```

### 模块功能

- **简单 API Key 认证**: 基于 Redis Set 存储，快速验证
- **签名请求认证**: 支持多种签名算法（MD5/SHA1/SHA256/HMAC_SHA256），包含时间戳验证、Nonce 防重放等安全特性

### 使用情况统计

- **引用次数**: 120+ 处
- **涉及文件**: 18 个文件
- **使用场景**:
  - `apps/admin-api`
  - `apps/iam-api`
  - `apps/fastify-api`
  - 多个业务模块

## 🔍 重命名评估

### 支持重命名为 `auth` 的理由

#### 1. 通用性

- ✅ `auth` 名称更通用，暗示模块可能包含多种认证方式
- ✅ 如果未来需要添加其他认证方式（如 OAuth、Basic Auth），`auth` 名称更合适

#### 2. 语义清晰

- ✅ `auth` 直接表达"认证"的含义，对不熟悉代码的开发者更友好
- ✅ 符合常见的命名约定（如 `auth`、`authentication`）

#### 3. 扩展性

- ✅ 为未来扩展预留空间，可以在 `auth` 模块下添加更多认证策略

### 不支持重命名为 `auth` 的理由

#### 1. 功能明确性 ⭐⭐⭐⭐⭐

- ❌ 当前模块**只处理 API Key 认证**，功能边界清晰
- ❌ `api-key` 名称**具体明确**，开发者一看就知道是 API Key 相关功能
- ❌ `auth` 名称**过于宽泛**，可能造成误解（是否包含 JWT、OAuth 等？）

**影响**: 高 - 命名应该准确反映模块的实际功能

#### 2. 架构一致性 ⭐⭐⭐⭐

- ❌ JWT 认证守卫在 `lib` 目录下，**不在子目录**
- ❌ 如果 `api-key` 改为 `auth`，会与 JWT 的组织方式**不一致**
- ❌ 可能造成架构混乱：为什么 JWT 不在 `auth` 目录下？

**影响**: 高 - 破坏架构一致性

#### 3. 未来扩展性 ⭐⭐⭐⭐

- ❌ 如果未来需要添加其他认证方式，更好的做法是：
  ```
  guard/lib/
  ├── api-key/      # API Key 认证
  ├── jwt/          # JWT 认证（可迁移）
  ├── oauth/        # OAuth 认证（未来）
  └── basic-auth/   # Basic Auth（未来）
  ```
- ❌ 而不是一个通用的 `auth` 模块，这样会导致：
  - 模块职责不清
  - 代码组织混乱
  - 难以维护

**影响**: 高 - 不利于未来扩展

#### 4. 重命名成本 ⭐⭐⭐

- ❌ 需要修改 **18 个文件**中的 **120+ 处引用**
- ❌ 包括：
  - 导入路径：`from '@hl8/guard/lib/api-key/...'`
  - 类名：`ApiKeyModule` → `AuthModule`（需要评估）
  - 文件名：所有 `api-key.*` 文件
  - 文档：README、注释等
- ❌ 可能引入：
  - 合并冲突
  - 测试失败
  - 文档不一致

**影响**: 中 - 需要大量工作，但可以自动化

#### 5. 命名约定 ⭐⭐⭐

- ❌ NestJS 生态系统中，通常使用**具体名称**：
  - `@nestjs/jwt` - JWT 模块
  - `@nestjs/passport` - Passport 模块
  - `@nestjs/config` - 配置模块
- ❌ 通用名称如 `auth` 容易造成混淆
- ❌ 不符合"单一职责"原则：一个模块应该专注于一个功能

**影响**: 中 - 不符合社区约定

#### 6. 代码可读性 ⭐⭐⭐

- ❌ `api-key` 名称在代码中更清晰：
  ```typescript
  import { ApiKeyModule } from '@hl8/guard';
  // vs
  import { AuthModule } from '@hl8/guard'; // 不够明确
  ```
- ❌ 如果使用 `AuthModule`，需要查看文档才能知道是 API Key 认证

**影响**: 中 - 降低代码可读性

## 💡 建议和结论

### 最终建议：**保持 `api-key` 名称不变** ✅

#### 核心理由

1. **功能明确性优先**: 模块名称应该准确反映其功能，`api-key` 比 `auth` 更具体明确
2. **架构一致性**: 保持与现有 JWT 守卫的组织方式一致
3. **符合约定**: 遵循 NestJS 生态系统的命名约定
4. **降低维护成本**: 避免不必要的重构和潜在问题

### 决策矩阵

| 评估维度   | 权重     | `api-key` 得分 | `auth` 得分 | 说明                   |
| ---------- | -------- | -------------- | ----------- | ---------------------- |
| 功能明确性 | 25%      | 5/5            | 2/5         | `api-key` 更具体       |
| 架构一致性 | 20%      | 5/5            | 2/5         | 保持现有结构           |
| 未来扩展性 | 20%      | 4/5            | 3/5         | 多模块方案更好         |
| 重命名成本 | 15%      | 5/5            | 2/5         | 避免不必要重构         |
| 命名约定   | 10%      | 5/5            | 3/5         | 符合 NestJS 约定       |
| 代码可读性 | 10%      | 5/5            | 3/5         | `api-key` 更清晰       |
| **总分**   | **100%** | **4.85/5**     | **2.55/5**  | **`api-key` 明显更优** |

## 🔄 替代方案

如果确实需要统一认证模块的组织方式，可以考虑以下方案：

### 方案 1：保持现状（推荐）⭐⭐⭐⭐⭐

**做法**: 保持 `api-key` 名称和当前结构不变

**优点**:

- ✅ 无需修改任何代码
- ✅ 功能明确，易于理解
- ✅ 符合单一职责原则

**缺点**:

- ⚠️ JWT 守卫不在子目录，结构不完全统一

**适用场景**: 当前场景（推荐）

### 方案 2：统一认证模块结构 ⭐⭐⭐

**做法**: 将 JWT 也迁移到子目录，统一结构

```
guard/lib/
├── api-key/     # API Key 认证模块
│   └── ...
├── jwt/         # JWT 认证模块（从 lib 迁移）
│   ├── jwt.module.ts
│   ├── jwt.guard.ts
│   └── ...
└── ...
```

**优点**:

- ✅ 结构统一，所有认证方式都在子目录
- ✅ 便于管理和扩展

**缺点**:

- ❌ 需要迁移 JWT 相关代码
- ❌ 需要更新所有 JWT 的引用
- ❌ 工作量大，收益有限

**适用场景**: 如果决定全面重构认证模块结构

### 方案 3：创建认证模块聚合器 ⭐⭐

**做法**: 保持现有结构，创建 `auth` 模块作为聚合器

```
guard/lib/
├── api-key/     # API Key 认证（保持原名）
├── jwt/         # JWT 认证（可选迁移）
└── auth/        # 认证聚合模块（新）
    └── auth.module.ts  # 导出所有认证模块
```

**优点**:

- ✅ 保持现有模块名称
- ✅ 提供统一的认证入口

**缺点**:

- ❌ 增加一层抽象，可能造成混淆
- ❌ 不符合实际需求（当前不需要聚合器）

**适用场景**: 如果需要统一管理多种认证方式

## 📝 未来考虑

### 如果未来需要添加其他认证方式

建议采用**多模块方案**，而不是单一的 `auth` 模块：

```
guard/lib/
├── api-key/          # API Key 认证
├── jwt/              # JWT 认证（可选迁移）
├── oauth/            # OAuth 认证（未来）
│   ├── oauth.module.ts
│   ├── oauth.guard.ts
│   └── strategies/
├── basic-auth/       # Basic Auth（未来）
│   └── ...
└── ...
```

**理由**:

- ✅ 每个模块职责单一，易于维护
- ✅ 模块名称具体明确，易于理解
- ✅ 符合单一职责原则
- ✅ 便于独立测试和部署

### 如果未来需要统一认证接口

可以考虑创建认证抽象层：

```typescript
// guard/lib/auth/auth.interface.ts
export interface IAuthGuard {
  canActivate(context: ExecutionContext): Promise<boolean>;
}

// 各个认证模块实现此接口
export class ApiKeyGuard implements IAuthGuard { ... }
export class JwtAuthGuard implements IAuthGuard { ... }
```

但**不需要**将模块重命名为 `auth`。

## ✅ 最终决策

**决策**: 保持 `api-key` 模块名称不变

**理由总结**:

1. ✅ 名称具体明确，准确反映功能
2. ✅ 符合 NestJS 命名约定
3. ✅ 保持架构一致性
4. ✅ 避免不必要的重构成本
5. ✅ 便于未来扩展（多模块方案）

**执行**: 无需任何操作，保持现状

## 📚 相关文档

- [API Key 模块文档](./README.md)
- [Guard 模块总览](../README.md)
- [项目架构文档](../../../../../docs/)

## 🔄 文档更新记录

| 日期 | 版本 | 更新内容               | 更新人 |
| ---- | ---- | ---------------------- | ------ |
| 2024 | 1.0  | 初始版本，记录命名评估 | -      |

---

**注意**: 本文档作为备忘记录，如果未来需要重新评估命名决策，应参考本文档的评估过程和结论。
