# Guard 目录重命名为 Auth 评估文档

## 📋 文档信息

- **评估日期**: 2024年
- **评估主题**: 是否将 `libs/infra/guard` 目录重命名为 `libs/infra/auth`
- **评估目的**: 记录目录重命名的评估过程和结论，作为架构决策参考

## 🎯 评估背景

当前 `libs/infra/guard` 目录已经包含了多种认证方式（api-key、jwt、basic-auth、oauth），且不仅包含守卫（Guard），还包含服务（Service）、模块（Module）等完整的认证功能。因此考虑是否将目录重命名为更通用的 `auth` 名称。

## 📊 当前架构

### 目录结构

```
libs/infra/guard/
├── src/lib/
│   ├── api-key/          # API Key 认证模块
│   │   ├── api-key.module.ts
│   │   ├── api-key.guard.ts
│   │   ├── services/
│   │   └── events/
│   ├── jwt/              # JWT 认证模块
│   │   ├── jwt.auth.guard.ts
│   │   └── jwt.auth.guard.spec.ts
│   ├── basic-auth/       # Basic Auth 认证模块（预留）
│   ├── oauth/            # OAuth 认证模块（预留）
│   └── EVALUATION.md     # API Key 模块命名评估
├── package.json          # @hl8/guard
├── README.md
└── ...
```

### 库的功能范围

**当前包含的内容：**

- ✅ **守卫（Guards）**: JwtAuthGuard, ApiKeyGuard
- ✅ **服务（Services）**: SimpleApiKeyService, ComplexApiKeyService
- ✅ **模块（Modules）**: ApiKeyModule
- ✅ **事件（Events）**: ApiKeyValidationEvent
- ✅ **策略（Strategies）**: 签名算法枚举
- ✅ **常量（Constants）**: 服务注入令牌

**职责范围：**

- 认证守卫实现
- 认证服务实现
- 认证模块配置
- 认证相关事件
- 认证策略和算法

### 使用情况统计

- **包名**: `@hl8/guard`
- **引用次数**: 69+ 处
- **涉及文件**: 32 个文件
- **使用场景**:
  - `apps/admin-api`
  - `apps/iam-api`
  - `apps/fastify-api`
  - `libs/infra/casbin`
  - 多个业务模块

### 相关库的命名

```
libs/infra/
├── adapter/      # 适配器库
├── casbin/       # 授权库（Casbin）
├── crypto/       # 加密库
├── decorators/   # 装饰器库
├── filters/      # 过滤器库
├── guard/        # 认证守卫库（当前）
├── rest/         # REST 工具库
└── strategies/   # 策略库（Passport 策略）
```

## 🔍 重命名评估

### 支持重命名为 `auth` 的理由

#### 1. 功能范围更准确 ⭐⭐⭐⭐

- ✅ 当前库不仅包含**守卫（Guard）**，还包含：
  - 服务（Service）
  - 模块（Module）
  - 事件（Event）
  - 策略和算法
- ✅ `auth` 名称更准确地反映了库的**完整功能范围**
- ✅ `guard` 名称过于狭窄，只强调了守卫部分

**影响**: 高 - 命名应该准确反映库的实际功能

#### 2. 语义更清晰 ⭐⭐⭐⭐

- ✅ `auth` 直接表达"认证"的含义，对开发者更友好
- ✅ `guard` 是 NestJS 的特定术语，对不熟悉框架的开发者可能不够直观
- ✅ `auth` 更符合通用软件开发的命名约定

**影响**: 高 - 提升代码可读性和可理解性

#### 3. 与相关库的区分 ⭐⭐⭐

- ✅ `libs/infra/strategies` 已经存在，专门处理 Passport 策略
- ✅ 如果 `guard` 重命名为 `auth`，职责划分更清晰：
  - `auth` - 认证守卫、服务、模块（应用层）
  - `strategies` - Passport 策略（框架层）
- ✅ 避免与 `strategies` 库的功能重叠感

**影响**: 中 - 提升架构清晰度

#### 4. 未来扩展性 ⭐⭐⭐

- ✅ `auth` 名称为未来扩展预留空间：
  - 可以添加更多认证方式（OAuth、SAML 等）
  - 可以添加认证中间件
  - 可以添加认证工具函数
- ✅ `guard` 名称暗示只包含守卫，限制了扩展性

**影响**: 中 - 便于未来扩展

### 不支持重命名为 `auth` 的理由

#### 1. NestJS 术语约定 ⭐⭐⭐⭐

- ❌ `Guard` 是 **NestJS 框架的核心概念**，使用 `@hl8/guard` 符合框架约定
- ❌ NestJS 官方文档和社区都使用 `Guard` 术语
- ❌ 保持与框架术语一致，降低学习成本

**影响**: 高 - 符合框架约定

#### 2. 重命名成本 ⭐⭐⭐⭐

- ❌ 需要修改 **32 个文件**中的 **69+ 处引用**
- ❌ 包括：
  - 包名：`@hl8/guard` → `@hl8/auth`
  - 导入路径：`from '@hl8/guard'` → `from '@hl8/auth'`
  - 目录名：`libs/infra/guard` → `libs/infra/auth`
  - 文档：README、注释等
  - 配置文件：package.json、tsconfig.json 等
- ❌ 可能引入：
  - 合并冲突
  - 测试失败
  - 文档不一致
  - CI/CD 配置更新

**影响**: 高 - 需要大量工作

#### 3. 与其他库的命名一致性 ⭐⭐⭐

- ❌ 其他 infra 库都使用**功能/职责名称**：
  - `filters` - 过滤器
  - `decorators` - 装饰器
  - `rest` - REST 工具
- ❌ `guard` 也是按功能命名（守卫功能），与整体命名风格一致
- ❌ 如果改为 `auth`，需要评估是否其他库也需要调整

**影响**: 中 - 保持命名一致性

#### 4. 包名语义 ⭐⭐⭐

- ❌ `@hl8/guard` 明确表示这是**守卫库**
- ❌ `@hl8/auth` 可能暗示包含所有认证相关内容（包括策略、中间件等）
- ❌ 但实际上策略在 `@hl8/strategies` 中，可能造成混淆

**影响**: 中 - 避免职责混淆

#### 5. 向后兼容性 ⭐⭐⭐

- ❌ 重命名会破坏现有代码的导入
- ❌ 需要同时维护两个包名一段时间（迁移期）
- ❌ 或者一次性迁移所有引用（风险较高）

**影响**: 中 - 影响现有代码

## 💡 建议和结论

### 最终建议：**保持 `guard` 名称不变** ✅

#### 核心理由

1. **符合 NestJS 约定**: `Guard` 是框架的核心概念，使用 `@hl8/guard` 符合框架约定和社区实践
2. **命名一致性**: 与其他 infra 库的命名风格一致（按功能命名）
3. **降低迁移成本**: 避免大规模重构和潜在风险
4. **职责清晰**: 虽然包含服务等，但核心职责是提供守卫功能

### 决策矩阵

| 评估维度       | 权重     | `guard` 得分 | `auth` 得分 | 说明                     |
| -------------- | -------- | ------------ | ----------- | ------------------------ |
| 功能范围准确性 | 20%      | 3/5          | 5/5         | `auth` 更准确            |
| 框架约定符合度 | 25%      | 5/5          | 3/5         | `guard` 符合 NestJS 约定 |
| 重命名成本     | 20%      | 5/5          | 2/5         | 避免不必要重构           |
| 命名一致性     | 15%      | 5/5          | 4/5         | `guard` 与其他库一致     |
| 语义清晰度     | 10%      | 4/5          | 5/5         | `auth` 更直观            |
| 未来扩展性     | 10%      | 4/5          | 5/5         | `auth` 更灵活            |
| **总分**       | **100%** | **4.25/5**   | **4.05/5**  | **`guard` 略优**         |

### 关键考虑因素

虽然 `auth` 在功能范围准确性上得分更高，但考虑到：

1. **框架约定优先**: NestJS 生态系统中，`Guard` 是标准术语
2. **迁移成本**: 69+ 处引用需要修改，风险较高
3. **命名一致性**: 与其他 infra 库保持一致的命名风格

**最终决策**: 保持 `guard` 名称不变

## 🔄 替代方案

### 方案 1：保持现状（推荐）⭐⭐⭐⭐⭐

**做法**: 保持 `guard` 名称和当前结构不变

**优点**:

- ✅ 无需修改任何代码
- ✅ 符合 NestJS 框架约定
- ✅ 与其他 infra 库命名一致
- ✅ 降低维护成本

**缺点**:

- ⚠️ 名称可能不够直观（对非 NestJS 开发者）

**适用场景**: 当前场景（推荐）

### 方案 2：创建认证聚合库 ⭐⭐⭐

**做法**: 保持 `guard` 不变，创建新的 `auth` 库作为聚合器

```
libs/infra/
├── guard/        # 守卫库（保持）
├── auth/         # 认证聚合库（新）
│   └── auth.module.ts  # 导出所有认证相关模块
└── ...
```

**优点**:

- ✅ 保持现有代码不变
- ✅ 提供统一的认证入口
- ✅ 便于未来扩展

**缺点**:

- ❌ 增加一层抽象，可能造成混淆
- ❌ 不符合实际需求（当前不需要聚合器）

**适用场景**: 如果需要统一管理多种认证方式

### 方案 3：渐进式重命名 ⭐⭐

**做法**: 分阶段重命名，同时维护两个包名

**优点**:

- ✅ 降低一次性迁移风险
- ✅ 可以逐步迁移

**缺点**:

- ❌ 需要维护两套代码
- ❌ 增加维护成本
- ❌ 可能造成混淆

**适用场景**: 不推荐

## 📝 未来考虑

### 如果未来需要扩展认证功能

建议在 `guard` 库内扩展，而不是重命名：

```
libs/infra/guard/
├── src/lib/
│   ├── api-key/
│   ├── jwt/
│   ├── basic-auth/
│   ├── oauth/
│   ├── saml/          # 未来扩展
│   └── middleware/    # 认证中间件（未来）
└── ...
```

**理由**:

- ✅ 保持与 NestJS 框架约定一致
- ✅ 避免大规模重构
- ✅ 职责仍然清晰（认证守卫相关）

### 如果未来需要更通用的认证库

可以考虑创建新的 `auth` 库，但保持 `guard` 库不变：

```
libs/infra/
├── guard/        # 守卫库（保持，专注于守卫）
├── auth/         # 认证库（新，包含认证的各个方面）
│   ├── guards/   # 从 guard 库导入
│   ├── services/ # 认证服务
│   ├── middleware/# 认证中间件
│   └── utils/    # 认证工具
└── ...
```

但**当前不需要**这样做。

## ✅ 最终决策

**决策**: 保持 `libs/infra/guard` 目录名称不变

**理由总结**:

1. ✅ 符合 NestJS 框架约定和社区实践
2. ✅ 与其他 infra 库的命名风格一致
3. ✅ 避免大规模重构和潜在风险
4. ✅ 职责清晰（虽然包含服务等，但核心是守卫功能）
5. ✅ 降低维护成本

**执行**: 无需任何操作，保持现状

## 📚 相关文档

- [API Key 模块命名评估](./src/lib/EVALUATION.md)
- [Guard 模块文档](./README.md)
- [NestJS Guards 官方文档](https://docs.nestjs.com/guards)

## 🔄 文档更新记录

| 日期 | 版本 | 更新内容                     | 更新人 |
| ---- | ---- | ---------------------------- | ------ |
| 2024 | 1.0  | 初始版本，记录目录重命名评估 | -      |

---

**注意**: 本文档作为架构决策记录（ADR - Architecture Decision Record）。如果未来需要重新评估此决策，应参考本文档的评估过程和结论，并考虑新的上下文变化。
