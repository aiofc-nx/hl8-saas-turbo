# 前后端邮件功能对齐检查报告

## 检查日期

2024-12-19

## 一、后端邮件功能

### 1. 注册流程

- **接口**: `POST /v1/auth/register`
- **功能**: 用户注册，创建用户账户
- **邮件发送**: 注册成功后，通过 `UserCreatedHandler` 事件处理器自动发送注册验证邮件
- **邮件内容**: 包含 6 位数字 OTP 验证码
- **OTP 存储**: 存储到 Redis，键为 `hl8:cache:email:verification:{email}`，有效期 10 分钟
- **返回消息**: "注册成功！验证码已发送到您的邮箱，请查收并完成邮箱验证"

### 2. 邮件发送

- **实现**: 使用 `@hl8/mail` 库的 `MailService` 和 `RegisterSuccessMail` 模板
- **配置**: 通过 `MailConfigProvider` 注入 `APP_NAME` 和 `APP_URL`
- **自动触发**: 用户创建事件（`UserCreatedEvent`）触发邮件发送

### 3. 缺失的后端接口

- ❌ **邮箱验证接口**: 后端**没有** `PATCH /v1/auth/confirm-email` 接口
- ❌ **重发验证码接口**: 后端**没有**重发验证码的接口

---

## 二、前端邮件功能

### 1. 注册流程

- **接口调用**: `authService.register()`
- **路径**: `POST /v1/auth/register`
- **行为**: 注册成功后跳转到 `/otp` 页面
- **提示消息**: "注册成功！验证码已发送到您的邮箱，请查收。"

### 2. OTP 验证页面

- **路径**: `/otp`
- **功能**:
  - 输入 6 位数字 OTP 验证码
  - 调用 `authService.confirmEmail()` 验证邮箱
  - 支持重发验证码功能

### 3. 前端 API 调用

#### 3.1 邮箱验证接口

```typescript
// 前端调用
authService.confirmEmail({
  email: string,
  token: string, // OTP 验证码
})

// 前端期望的接口
PATCH / v1 / auth / confirm - email
```

#### 3.2 重发验证码接口

```typescript
// 前端调用
authService.resendConfirmationEmail(email: string)

// 前端期望的接口（需要确认路径）
POST /v1/auth/resend-verification-code
// 或
POST /v1/auth/resend-confirmation-email
```

---

## 三、对齐问题

### 🔴 严重问题

#### 1. 缺失邮箱验证接口

- **问题**: 前端调用 `PATCH /v1/auth/confirm-email`，但后端**没有此接口**
- **影响**: 用户无法完成邮箱验证，注册流程无法完成
- **需要实现**:
  - 验证 Redis 中的 OTP 验证码
  - 验证成功后更新用户邮箱验证状态
  - 返回登录令牌（或直接登录）

#### 2. 缺失重发验证码接口

- **问题**: 前端调用 `resendConfirmationEmail()`，但后端**没有此接口**
- **影响**: 用户无法重新获取验证码
- **需要实现**:
  - 重新生成 OTP 验证码
  - 重新发送注册验证邮件
  - 更新 Redis 中的验证码

### 🟡 中等问题

#### 3. 注册响应消息对齐

- **后端返回**: "注册成功！验证码已发送到您的邮箱，请查收并完成邮箱验证"
- **前端显示**: "注册成功！验证码已发送到您的邮箱，请查收。"
- **状态**: ✅ 基本对齐，前端消息可以更详细

---

## 四、需要实现的后端接口

### 1. 邮箱验证接口

**接口**: `PATCH /v1/auth/confirm-email`

**请求体**:

```typescript
{
  email: string
  token: string // 6 位数字 OTP 验证码
}
```

**功能**:

1. 从 Redis 中获取存储的 OTP 验证码（键：`hl8:cache:email:verification:{email}`）
2. 验证 OTP 是否匹配
3. 验证 OTP 是否过期（10 分钟）
4. 验证成功后：
   - 更新用户邮箱验证状态
   - 删除 Redis 中的 OTP 验证码
   - 返回登录令牌（或直接登录）

**响应**:

```typescript
{
  message: string
  data: {
    // 用户数据
    id: string
    email: string
    username: string
    isEmailVerified: true
    // ...
  }
  tokens: {
    access_token: string
    refresh_token: string
    session_token: string
    // ...
  }
}
```

### 2. 重发验证码接口

**接口**: `POST /v1/auth/resend-verification-code`

**请求体**:

```typescript
{
  email: string
}
```

**功能**:

1. 验证邮箱是否已注册
2. 验证邮箱是否已验证（如果已验证，返回错误）
3. 重新生成 6 位数字 OTP 验证码
4. 更新 Redis 中的 OTP 验证码（覆盖旧的）
5. 重新发送注册验证邮件

**响应**:

```typescript
{
  message: '验证码已重新发送到您的邮箱，请查收'
}
```

---

## 五、建议

### 优先级 P0 - 必须立即实现

1. **实现邮箱验证接口** (`PATCH /v1/auth/confirm-email`)
   - 这是注册流程的关键步骤，没有此接口用户无法完成注册

2. **实现重发验证码接口** (`POST /v1/auth/resend-verification-code`)
   - 提升用户体验，允许用户重新获取验证码

### 优先级 P1 - 建议实现

3. **统一响应消息格式**
   - 确保前后端消息一致

4. **添加验证码过期提示**
   - 前端可以显示验证码有效期（10 分钟）

---

## 六、总结

### 当前状态

- ✅ 注册接口已对齐
- ✅ 邮件发送功能已实现
- ❌ 邮箱验证接口缺失
- ❌ 重发验证码接口缺失

### 对齐度评分

**6/10** - 基础功能已实现，但关键验证流程缺失

### 下一步行动

1. 实现 `PATCH /v1/auth/confirm-email` 接口
2. 实现 `POST /v1/auth/resend-verification-code` 接口
3. 测试完整的注册-验证流程
