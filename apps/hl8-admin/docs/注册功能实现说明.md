# 注册功能实现说明

## 概述

已成功实现公开注册功能，用户现在可以通过邮箱和密码进行自主注册。

## 实现内容

### 1. 后端实现

#### 1.1 注册 DTO (`apps/admin-api/src/api/iam/dto/register.dto.ts`)

创建了 `RegisterDto` 类，包含：

- `email`: 必填，邮箱地址（唯一）
- `password`: 必填，密码（最小长度 6）
- `username`: 可选，用户名（如果未提供，自动生成）
- `nickName`: 可选，昵称（如果未提供，使用邮箱前缀）

#### 1.2 注册接口 (`apps/admin-api/src/api/iam/rest/authentication.controller.ts`)

在 `AuthenticationController` 中添加了 `@Public()` 的注册接口：

```typescript
@Public()
@Post('register')
async register(@Body() dto: RegisterDto): Promise<ApiRes<{ message: string }>>
```

**接口路径**: `POST /v1/auth/register`

**功能**:

1. 检查邮箱是否已存在
2. 自动生成用户名（如果未提供）
3. 自动生成昵称（如果未提供）
4. 使用默认域创建用户（默认域：`public`，可通过环境变量 `PUBLIC_REGISTER_DOMAIN` 配置）
5. 创建用户并返回成功消息

**错误处理**:

- 邮箱已存在：返回 `BadRequestException`，提示"该邮箱已被注册"
- 无法生成唯一用户名：返回 `BadRequestException`，提示"无法生成唯一用户名"

### 2. 前端实现

#### 2.1 更新注册服务 (`apps/hl8-admin/src/lib/services/auth.service.ts`)

更新了 `register` 方法，调用新的注册接口：

```typescript
async register(data: RegisterRequest): Promise<ApiResponse> {
  const response = await apiClient.post<ApiResponse>(
    '/auth/register',
    {
      email: data.email,
      password: data.password,
    },
    {
      skipDataExtraction: true,
    },
  )
  return response.data as ApiResponse
}
```

## 配置说明

### 环境变量

在 `apps/admin-api/.env` 中可以配置：

```env
# 公开注册的默认域（可选，默认为 'public'）
PUBLIC_REGISTER_DOMAIN=public
```

如果不设置，将使用默认值 `'public'`。

## 使用示例

### 前端调用

```typescript
import { authService } from '@/lib/services/auth.service'

try {
  await authService.register({
    email: 'user@example.com',
    password: 'password123',
  })
  // 注册成功
} catch (error) {
  // 处理错误
}
```

### API 请求示例

```bash
curl -X POST http://localhost:9528/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

**成功响应**:

```json
{
  "code": 200,
  "message": "注册成功！请使用邮箱和密码登录",
  "data": {
    "message": "注册成功！请使用邮箱和密码登录"
  }
}
```

**错误响应**（邮箱已存在）:

```json
{
  "code": 400,
  "message": "该邮箱已被注册，请使用其他邮箱或直接登录",
  "error": {
    "code": 400,
    "message": "该邮箱已被注册，请使用其他邮箱或直接登录"
  }
}
```

## 用户名生成规则

1. 如果用户提供了用户名，直接使用
2. 如果未提供用户名：
   - 使用邮箱前缀（`@` 之前的部分）
   - 如果邮箱前缀长度不足 6 位，添加时间戳后缀
3. 如果生成的用户名已存在，添加时间戳后缀重试（最多 10 次）

## 注意事项

1. **默认域**: 公开注册的用户将使用默认域 `'public'`（或环境变量配置的域）
2. **创建者**: 公开注册的用户创建者 ID 为 `'system'`
3. **邮箱唯一性**: 系统会检查邮箱是否已存在，确保邮箱唯一
4. **密码安全**: 密码使用 bcrypt 加密存储
5. **用户状态**: 新注册的用户状态为 `ENABLED`（启用）

## 后续优化建议

1. **邮箱验证**: 可以添加邮箱验证码发送功能，注册后需要验证邮箱才能登录
2. **密码强度**: 可以添加更严格的密码强度验证规则
3. **注册限制**: 可以添加注册频率限制，防止恶意注册
4. **欢迎邮件**: 可以在 `UserCreatedEvent` 事件处理器中发送欢迎邮件

## 测试步骤

1. 启动后端服务
2. 启动前端服务
3. 访问注册页面
4. 填写邮箱和密码
5. 点击"创建账户"
6. 验证注册是否成功
7. 尝试使用注册的邮箱和密码登录

## 相关文件

- 后端注册接口: `apps/admin-api/src/api/iam/rest/authentication.controller.ts`
- 注册 DTO: `apps/admin-api/src/api/iam/dto/register.dto.ts`
- 前端注册服务: `apps/hl8-admin/src/lib/services/auth.service.ts`
- 注册表单: `apps/hl8-admin/src/features/auth/sign-up/components/sign-up-form.tsx`
