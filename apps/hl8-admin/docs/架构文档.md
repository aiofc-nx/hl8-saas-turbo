# HL8 Admin 架构文档

## 1. 项目概述

`hl8-admin` 是一个基于 React + TypeScript 构建的现代化管理后台应用，采用组件化、模块化的架构设计，提供完整的用户认证、权限管理、数据展示和业务功能。

### 1.1 核心特性

- **类型安全**：全面使用 TypeScript，确保类型安全
- **响应式设计**：支持桌面端、平板和移动端
- **主题系统**：支持浅色/深色模式切换
- **国际化支持**：支持 RTL（从右到左）布局
- **路由管理**：基于文件系统的类型安全路由
- **状态管理**：使用 Zustand 进行轻量级状态管理
- **数据获取**：使用 TanStack Query 进行服务端状态管理
- **UI 组件库**：基于 Shadcn UI + Radix UI + TailwindCSS

## 2. 技术栈

### 2.1 核心框架

| 技术       | 版本    | 用途     |
| ---------- | ------- | -------- |
| React      | ^19.2.0 | UI 框架  |
| TypeScript | ~5.9.3  | 类型系统 |
| Vite       | ^7.1.11 | 构建工具 |

### 2.2 路由与状态管理

| 技术            | 版本      | 用途                     |
| --------------- | --------- | ------------------------ |
| TanStack Router | ^1.132.47 | 类型安全的路由管理       |
| TanStack Query  | ^5.90.2   | 服务端状态管理和数据获取 |
| Zustand         | ^5.0.8    | 客户端状态管理           |

### 2.3 UI 组件库

| 技术         | 版本     | 用途            |
| ------------ | -------- | --------------- |
| Shadcn UI    | -        | UI 组件库基础   |
| Radix UI     | -        | 无障碍组件原语  |
| TailwindCSS  | ^4.1.14  | 原子化 CSS 框架 |
| Lucide React | ^0.545.0 | 图标库          |

### 2.4 表单与验证

| 技术                | 版本    | 用途           |
| ------------------- | ------- | -------------- |
| React Hook Form     | ^7.64.0 | 表单状态管理   |
| Zod                 | ^4.1.12 | Schema 验证    |
| @hookform/resolvers | ^5.2.2  | 表单验证解析器 |

### 2.5 工具库

| 技术     | 版本    | 用途        |
| -------- | ------- | ----------- |
| Axios    | ^1.12.2 | HTTP 客户端 |
| date-fns | ^4.1.0  | 日期处理    |
| Sonner   | ^2.0.7  | Toast 通知  |
| Recharts | ^3.2.1  | 图表库      |

## 3. 目录结构

```
apps/hl8-admin/
├── src/
│   ├── assets/              # 静态资源（图片、图标等）
│   ├── components/          # 可复用组件
│   │   ├── ui/             # Shadcn UI 基础组件
│   │   ├── layout/         # 布局组件
│   │   └── ...             # 其他业务组件
│   ├── config/             # 配置文件
│   ├── context/            # React Context 提供者
│   │   ├── theme-provider.tsx
│   │   ├── font-provider.tsx
│   │   └── direction-provider.tsx
│   ├── features/           # 功能模块（按业务领域划分）
│   │   ├── auth/          # 认证模块
│   │   ├── users/         # 用户管理
│   │   ├── apps/          # 应用管理
│   │   ├── tasks/         # 任务管理
│   │   ├── chats/         # 聊天功能
│   │   ├── settings/      # 设置模块
│   │   ├── errors/        # 错误页面
│   │   ├── landing/        # 首页
│   │   └── dashboard/     # 仪表盘
│   ├── hooks/              # 自定义 React Hooks
│   ├── lib/                # 工具库和业务逻辑
│   │   ├── api-client.ts   # API 客户端封装
│   │   ├── services/      # 业务服务层
│   │   │   └── auth.service.ts
│   │   └── utils.ts        # 工具函数
│   ├── routes/             # 路由定义（文件系统路由）
│   │   ├── __root.tsx      # 根路由
│   │   ├── index.tsx       # 首页路由
│   │   ├── _authenticated/ # 需要认证的路由组
│   │   ├── (auth)/         # 认证相关路由组
│   │   └── (errors)/       # 错误页面路由组
│   ├── stores/             # Zustand 状态存储
│   │   └── auth-store.ts   # 认证状态管理
│   ├── styles/             # 全局样式
│   ├── main.tsx            # 应用入口
│   └── routeTree.gen.ts    # 自动生成的路由树
├── public/                 # 公共静态资源
├── index.html              # HTML 模板
├── vite.config.ts          # Vite 配置
├── tsconfig.json           # TypeScript 配置
└── package.json            # 项目依赖
```

## 4. 架构模式

### 4.1 整体架构

项目采用**分层架构**和**特性模块化**的设计模式：

```
┌─────────────────────────────────────────┐
│          Presentation Layer            │
│  (Routes, Components, Features)        │
├─────────────────────────────────────────┤
│          State Management               │
│  (Zustand Stores, React Query)         │
├─────────────────────────────────────────┤
│          Service Layer                  │
│  (API Client, Services)                │
├─────────────────────────────────────────┤
│          Infrastructure                 │
│  (HTTP Client, Utils, Config)           │
└─────────────────────────────────────────┘
```

### 4.2 特性模块化（Feature-Based）

每个功能模块（`features/`）都是自包含的，包含：

- **组件**：该功能相关的 UI 组件
- **逻辑**：业务逻辑和数据处理
- **类型**：TypeScript 类型定义
- **Hooks**：自定义 React Hooks（如果需要）

这种组织方式使得：

- 模块之间低耦合
- 易于维护和扩展
- 便于团队协作（不同开发者负责不同模块）

### 4.3 组件分层

```
components/
├── ui/              # 基础 UI 组件（按钮、输入框等）
├── layout/          # 布局组件（侧边栏、头部等）
└── [业务组件]        # 业务相关的可复用组件
```

## 5. 核心模块详解

### 5.1 路由系统（TanStack Router）

#### 5.1.1 文件系统路由

使用**文件系统路由**模式，路由定义与文件结构一一对应：

```
routes/
├── index.tsx                    → /
├── _authenticated/              → /_authenticated (布局路由)
│   ├── route.tsx               → 布局组件
│   ├── apps/
│   │   └── index.tsx          → /apps
│   ├── users/
│   │   └── index.tsx          → /users
│   └── settings/
│       └── index.tsx           → /settings
├── (auth)/                      → 路由组（不影响 URL）
│   ├── sign-in.tsx             → /sign-in
│   └── sign-up.tsx             → /sign-up
└── (errors)/                    → 错误页面路由组
    ├── 404.tsx                  → /404
    └── 500.tsx                  → /500
```

#### 5.1.2 路由特性

- **类型安全**：路由路径、参数、查询字符串都有类型检查
- **自动代码分割**：每个路由自动进行代码分割
- **预加载**：支持基于意图的预加载（`defaultPreload: 'intent'`）
- **布局路由**：使用 `_authenticated` 前缀定义需要认证的布局

#### 5.1.3 路由守卫

在 `_authenticated/route.tsx` 中实现路由级别的重定向：

```typescript
export const Route = createFileRoute('/_authenticated')({
  beforeLoad: () => {
    throw redirect({ to: '/apps', replace: true })
  },
  component: AuthenticatedLayout,
})
```

### 5.2 状态管理

#### 5.2.1 客户端状态（Zustand）

使用 Zustand 管理全局客户端状态，目前主要用于认证状态：

```typescript
// stores/auth-store.ts
export const useAuthStore = create<AuthStore>((set) => ({
  auth: {
    // 认证状态和方法
    isAuthenticated: () => { ... },
    setUser: (user) => { ... },
    reset: () => { ... },
  },
}))
```

**优势**：

- 轻量级，API 简洁
- 无需 Provider 包裹
- 支持 TypeScript
- 性能优秀

#### 5.2.2 服务端状态（TanStack Query）

使用 TanStack Query 管理所有服务端状态：

```typescript
// 查询示例
const { data, isLoading, error } = useQuery({
  queryKey: ['users'],
  queryFn: () => apiClient.get('/users'),
})

// 变更示例
const mutation = useMutation({
  mutationFn: (data) => apiClient.post('/users', data),
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['users'] })
  },
})
```

**特性**：

- 自动缓存管理
- 请求去重
- 后台重新获取
- 乐观更新支持
- 错误重试策略

#### 5.2.3 全局错误处理

在 `main.tsx` 中配置全局错误处理：

```typescript
const queryClient = new QueryClient({
  queryCache: new QueryCache({
    onError: (error) => {
      // 处理 401（未授权）
      if (error.response?.status === 401) {
        // 清除认证状态，跳转登录
      }
      // 处理 500（服务器错误）
      if (error.response?.status === 500) {
        // 跳转错误页面
      }
    },
  }),
})
```

### 5.3 API 客户端

#### 5.3.1 Axios 封装

`lib/api-client.ts` 提供了统一的 HTTP 客户端：

**特性**：

- 请求/响应拦截器
- 自动添加认证 Token
- 统一错误处理
- 设备信息收集
- 请求日志（开发环境）

**使用示例**：

```typescript
import { apiClient } from '@/lib/api-client'

// GET 请求
const users = await apiClient.get<User[]>('/users')

// POST 请求
const newUser = await apiClient.post<User>('/users', userData)

// 带类型安全的请求
const response = await apiClient.get<ApiResponse<User[]>>('/users')
```

#### 5.3.2 服务层（Services）

业务逻辑封装在 `lib/services/` 中：

```typescript
// lib/services/auth.service.ts
export const authService = {
  signIn: async (credentials) => {
    return apiClient.post<SignInResponse>('/auth/sign-in', credentials)
  },
  signOut: async () => {
    return apiClient.post('/auth/sign-out')
  },
  // ...
}
```

### 5.4 认证系统

#### 5.4.1 认证流程

```
用户登录
  ↓
调用 authService.signIn()
  ↓
获取 Token 和用户信息
  ↓
存储到 Cookie（access_token, refresh_token, user_data）
  ↓
更新 Zustand Store
  ↓
跳转到 /apps
```

#### 5.4.2 Token 管理

- **存储位置**：Cookie（HttpOnly，由后端设置）
- **Token 类型**：
  - `access_token`：访问令牌
  - `refresh_token`：刷新令牌
  - `session_token`：会话令牌
- **自动刷新**：通过 Axios 拦截器实现

#### 5.4.3 认证状态检查

```typescript
// 在组件中使用
const { auth } = useAuthStore()
if (auth.isAuthenticated()) {
  // 已认证逻辑
}
```

### 5.5 UI 组件系统

#### 5.5.1 Shadcn UI 组件

基于 Shadcn UI 的组件系统，特点：

- **可定制**：组件代码在项目中，可自由修改
- **无障碍**：基于 Radix UI，支持键盘导航和屏幕阅读器
- **主题化**：支持 CSS 变量主题切换

#### 5.5.2 布局组件

```
components/layout/
├── authenticated-layout.tsx    # 认证后的主布局
├── main.tsx                     # 主内容区域
├── sidebar/                     # 侧边栏相关
└── ...
```

#### 5.5.3 主题系统

使用 CSS 变量实现主题切换：

```css
:root {
  --background: 0 0% 100%;
  --foreground: 222.2 84% 4.9%;
  /* ... */
}

.dark {
  --background: 222.2 84% 4.9%;
  --foreground: 210 40% 98%;
  /* ... */
}
```

通过 `ThemeProvider` 管理主题状态，支持：

- 浅色/深色模式
- 系统主题跟随
- 持久化存储

## 6. 数据流

### 6.1 数据获取流程

```
组件
  ↓
useQuery / useMutation
  ↓
TanStack Query
  ↓
API Client (Axios)
  ↓
HTTP 请求
  ↓
后端 API
  ↓
响应数据
  ↓
TanStack Query 缓存
  ↓
组件重新渲染
```

### 6.2 状态更新流程

```
用户操作
  ↓
触发 Mutation
  ↓
调用 Service 方法
  ↓
API Client 发送请求
  ↓
成功后更新 Zustand Store（如需要）
  ↓
Invalidate Query（使缓存失效）
  ↓
自动重新获取数据
  ↓
UI 更新
```

## 7. 构建与配置

### 7.1 Vite 配置

```typescript
// vite.config.ts
export default defineConfig({
  plugins: [
    tanstackRouter({
      target: 'react',
      autoCodeSplitting: true, // 自动代码分割
    }),
    react(), // React 支持
    tailwindcss(), // TailwindCSS
  ],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'), // 路径别名
    },
  },
})
```

### 7.2 TypeScript 配置

- **严格模式**：启用所有严格检查
- **模块系统**：ESNext
- **路径别名**：`@/*` → `./src/*`
- **JSX**：React JSX Transform

### 7.3 代码质量工具

- **ESLint**：代码检查
- **Prettier**：代码格式化
- **TypeScript**：类型检查
- **Knip**：未使用代码检测

## 8. 开发规范

### 8.1 文件命名

- **组件文件**：PascalCase（`UserProfile.tsx`）
- **工具文件**：kebab-case（`api-client.ts`）
- **路由文件**：kebab-case（`sign-in.tsx`）

### 8.2 代码组织

- **单一职责**：每个文件/函数只做一件事
- **模块化**：按功能模块组织代码
- **可复用**：提取公共逻辑到 hooks/utils

### 8.3 类型定义

- **接口命名**：PascalCase，以 `I` 开头或描述性名称
- **类型导出**：在相关文件中定义并导出
- **避免 any**：尽可能使用具体类型

### 8.4 注释规范

遵循 TSDoc 规范，使用中文注释：

```typescript
/**
 * 用户认证服务
 * 提供登录、注册、登出等认证相关功能
 *
 * @description 所有认证相关的 API 调用都通过此服务进行
 */
export const authService = {
  // ...
}
```

## 9. 性能优化

### 9.1 代码分割

- **路由级别**：每个路由自动代码分割
- **组件级别**：使用 `React.lazy()` 懒加载

### 9.2 缓存策略

- **TanStack Query**：自动缓存查询结果
- **Stale Time**：10 秒（可在配置中调整）
- **Cache Time**：默认 5 分钟

### 9.3 渲染优化

- **React.memo**：避免不必要的重渲染
- **useMemo/useCallback**：缓存计算结果和函数
- **虚拟滚动**：大数据列表使用虚拟滚动

## 10. 安全考虑

### 10.1 认证安全

- Token 存储在 HttpOnly Cookie 中
- 自动 Token 刷新机制
- 401 错误自动跳转登录

### 10.2 XSS 防护

- React 自动转义
- 避免使用 `dangerouslySetInnerHTML`
- 输入验证和清理

### 10.3 CSRF 防护

- 使用 SameSite Cookie
- 后端验证 CSRF Token

## 11. 测试策略

### 11.1 测试类型

- **单元测试**：工具函数、Hooks
- **组件测试**：UI 组件渲染和交互
- **集成测试**：功能模块的完整流程
- **E2E 测试**：关键用户流程

### 11.2 测试工具

- **Vitest**：单元测试框架
- **React Testing Library**：组件测试
- **Playwright**：E2E 测试（可选）

## 12. 部署

### 12.1 构建命令

```bash
pnpm run build
```

生成静态文件到 `dist/` 目录。

### 12.2 环境变量

- `VITE_API_BASE_URL`：API 基础地址
- `VITE_APP_TITLE`：应用标题
- 其他环境相关配置

### 12.3 部署目标

- **静态托管**：Netlify、Vercel、GitHub Pages
- **CDN**：通过 CDN 加速静态资源
- **容器化**：Docker + Nginx（可选）

## 13. 未来规划

### 13.1 功能扩展

- [ ] 国际化（i18n）支持
- [ ] 更多业务模块
- [ ] 实时通信（WebSocket）
- [ ] 离线支持（PWA）

### 13.2 技术优化

- [ ] 性能监控和分析
- [ ] 错误追踪（Sentry）
- [ ] 自动化测试覆盖
- [ ] 文档完善

## 14. 参考资料

- [TanStack Router 文档](https://tanstack.com/router/latest)
- [TanStack Query 文档](https://tanstack.com/query/latest)
- [Shadcn UI 文档](https://ui.shadcn.com)
- [React 文档](https://react.dev)
- [TypeScript 文档](https://www.typescriptlang.org)

---

**文档版本**：1.0.0  
**最后更新**：2024年  
**维护者**：HL8 开发团队
