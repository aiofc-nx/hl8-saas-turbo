# 前后端连接故障排查指南

## 问题现象

前端显示错误：**"网络错误，无法连接到服务器"**

## 快速检查清单

### 1. 检查后端服务状态

```bash
# 检查后端进程是否运行
ps aux | grep "nest.*admin-api" | grep -v grep

# 检查后端端口是否监听
netstat -tlnp | grep 9528
# 或
lsof -i :9528
```

### 2. 检查后端配置

```bash
cd apps/admin-api
cat .env | grep -E "^(APP_PORT|PORT|CORS)"
```

**预期结果**:

- `APP_PORT=9528`
- `CORS_ENABLED=true`
- `CORS_ORIGIN` 包含前端运行地址

### 3. 检查前端环境变量

```bash
cd apps/hl8-admin
cat .env.local
```

**预期结果**:

```env
VITE_API_BASE_URL=http://localhost:9528/v1
```

### 4. 测试后端连接

```bash
# 测试后端是否可达
curl http://localhost:9528/v1/auth/getUserInfo

# 预期返回 401（需要认证），说明服务可达
# 如果返回连接错误，说明服务不可达
```

### 5. 测试 CORS 配置

```bash
curl -I -H "Origin: http://localhost:5173" \
     -H "Access-Control-Request-Method: POST" \
     -X OPTIONS \
     http://localhost:9528/v1/auth/login
```

**预期结果**: 应该看到 `access-control-allow-origin` 头

## 常见问题及解决方案

### 问题 1: 后端服务未启动

**症状**: curl 测试返回连接错误

**解决方案**:

```bash
cd apps/admin-api
pnpm run dev
```

### 问题 2: 前端环境变量未加载

**症状**: 前端使用默认地址 `http://localhost:8000`

**解决方案**:

1. 确认 `.env.local` 文件存在且配置正确
2. **重启前端开发服务器**（重要！）
   ```bash
   cd apps/hl8-admin
   # 停止当前服务器 (Ctrl+C)
   pnpm run dev
   ```

### 问题 3: CORS 配置不正确

**症状**: 浏览器控制台显示 CORS 错误

**解决方案**:

1. 检查后端 `.env` 文件中的 `CORS_ORIGIN`
2. 确保包含前端实际运行地址（如 `http://localhost:5173`）
3. 重启后端服务

### 问题 4: 端口不匹配

**症状**: 前端配置的端口与后端实际端口不一致

**解决方案**:

1. 确认后端实际运行端口
2. 更新前端 `.env.local` 中的 `VITE_API_BASE_URL`
3. 重启前端开发服务器

### 问题 5: 网络连接问题

**症状**: 所有测试都失败

**解决方案**:

1. 检查防火墙设置
2. 检查是否有其他服务占用端口
3. 尝试使用 `127.0.0.1` 代替 `localhost`

## 调试步骤

### 步骤 1: 验证后端服务

```bash
# 1. 检查后端是否运行
ps aux | grep nest

# 2. 检查后端日志
# 查看运行后端的终端窗口，确认没有错误

# 3. 测试后端 API
curl http://localhost:9528/v1/auth/getUserInfo
# 应该返回 401（需要认证），而不是连接错误
```

### 步骤 2: 验证前端配置

```bash
# 1. 检查环境变量文件
cat apps/hl8-admin/.env.local

# 2. 检查前端代码中的默认值
# 查看 src/lib/api-client.ts 中的 baseURL

# 3. 在浏览器控制台检查
# 打开浏览器开发者工具，在 Console 中运行：
# console.log(import.meta.env.VITE_API_BASE_URL)
```

### 步骤 3: 验证网络连接

```bash
# 1. 测试基本连接
ping localhost

# 2. 测试端口
telnet localhost 9528
# 或
nc -zv localhost 9528

# 3. 测试 HTTP 连接
curl -v http://localhost:9528/v1/auth/getUserInfo
```

### 步骤 4: 检查浏览器控制台

1. 打开浏览器开发者工具 (F12)
2. 查看 **Network** 标签
3. 找到失败的请求
4. 检查：
   - 请求 URL 是否正确
   - 请求方法是否正确
   - 响应状态码
   - 错误消息

## 快速修复命令

### 重启后端服务

```bash
cd apps/admin-api
# 停止当前服务 (Ctrl+C)
pnpm run dev
```

### 重启前端服务

```bash
cd apps/hl8-admin
# 停止当前服务 (Ctrl+C)
pnpm run dev
```

### 更新 CORS 配置

```bash
cd apps/admin-api
# 编辑 .env 文件，更新 CORS_ORIGIN
# 然后重启后端服务
```

### 更新前端环境变量

```bash
cd apps/hl8-admin
# 编辑 .env.local 文件
# 然后重启前端服务
```

## 验证修复

修复后，执行以下测试：

1. **后端连接测试**:

   ```bash
   curl http://localhost:9528/v1/auth/getUserInfo
   # 应该返回 401，不是连接错误
   ```

2. **前端功能测试**:
   - 打开前端应用
   - 尝试登录
   - 检查浏览器 Network 标签
   - 确认请求发送到正确的地址

3. **CORS 测试**:
   - 打开浏览器开发者工具
   - 查看 Console 标签
   - 确认没有 CORS 错误

## 仍然无法解决？

如果以上步骤都无法解决问题，请检查：

1. **后端日志**: 查看后端终端输出的错误信息
2. **前端日志**: 查看浏览器控制台的错误信息
3. **系统日志**: 检查系统是否有端口占用或其他问题
4. **网络配置**: 检查是否有代理、VPN 等影响连接

---

**最后更新**: 2025-11-30
