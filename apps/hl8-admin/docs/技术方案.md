# hl8-admin 技术方案文档

## 1. 项目概述

`hl8-admin` 是一个基于 React 19 和 TypeScript 构建的现代化管理后台应用，采用 Monorepo 架构，作为 hl8-saas-turbo 项目的前端管理端。

### 1.1 项目定位

- **类型**：单页应用（SPA）
- **用途**：企业级 SaaS 平台的管理后台
- **目标用户**：系统管理员、运营人员
- **核心功能**：用户管理、角色权限、域名管理、系统设置等

### 1.2 技术选型原则

- **现代化**：采用最新的 React 19 和 TypeScript 5.9
- **类型安全**：严格的 TypeScript 配置，确保类型安全
- **开发体验**：Vite 构建工具，支持 HMR 和快速构建
- **可维护性**：清晰的代码结构，完善的注释文档
- **性能优化**：代码分割、懒加载、请求缓存

## 2. 技术栈

### 2.1 核心框架

| 技术       | 版本   | 用途     |
| ---------- | ------ | -------- |
| React      | 19.2.0 | UI 框架  |
| TypeScript | 5.9.3  | 类型系统 |
| Vite       | 7.1.11 | 构建工具 |

### 2.2 路由与导航

| 技术                     | 版本     | 用途               |
| ------------------------ | -------- | ------------------ |
| TanStack Router          | 1.132.47 | 类型安全的路由管理 |
| TanStack Router Devtools | 1.132.51 | 路由开发工具       |

**特性**：

- 类型安全的路由定义
- 自动代码分割
- 路由预加载（intent-based）
- 文件系统路由

### 2.3 数据获取与状态管理

| 技术           | 版本   | 用途                     |
| -------------- | ------ | ------------------------ |
| TanStack Query | 5.90.2 | 服务端状态管理、数据获取 |
| Zustand        | 5.0.8  | 客户端状态管理           |
| Axios          | 1.13.2 | HTTP 客户端              |

**特性**：

- 自动缓存和重新验证
- 请求去重和重试机制
- 乐观更新支持
- 轻量级状态管理（Zustand）

### 2.4 UI 框架与样式

| 技术         | 版本    | 用途                     |
| ------------ | ------- | ------------------------ |
| TailwindCSS  | 4.1.14  | 原子化 CSS 框架          |
| Radix UI     | 多个包  | 无样式、可访问的 UI 组件 |
| Shadcn UI    | -       | 基于 Radix UI 的组件库   |
| Lucide React | 0.545.0 | 图标库                   |

**特性**：

- 响应式设计
- 深色/浅色主题切换
- RTL（从右到左）语言支持
- 完整的可访问性支持

### 2.5 表单处理

| 技术                | 版本   | 用途           |
| ------------------- | ------ | -------------- |
| React Hook Form     | 7.64.0 | 表单状态管理   |
| Zod                 | 4.1.12 | 数据验证       |
| @hookform/resolvers | 5.2.2  | 表单验证解析器 |

### 2.6 工具库

| 技术                     | 版本  | 用途              |
| ------------------------ | ----- | ----------------- |
| date-fns                 | 4.1.0 | 日期处理          |
| clsx                     | 2.1.1 | 条件类名合并      |
| tailwind-merge           | 3.3.1 | Tailwind 类名合并 |
| class-variance-authority | 0.7.1 | 组件变体管理      |
| sonner                   | 2.0.7 | Toast 通知        |
| recharts                 | 3.2.1 | 图表库            |

### 2.7 开发工具

| 技术              | 版本   | 用途                |
| ----------------- | ------ | ------------------- |
| ESLint            | 9.39.1 | 代码检查            |
| Prettier          | 3.6.2  | 代码格式化          |
| TypeScript ESLint | 8.47.0 | TypeScript 代码检查 |
| Knip              | 5.64.2 | 未使用代码检测      |

## 3. 项目架构

### 3.1 目录结构

```
apps/hl8-admin/
├── src/
│   ├── assets/              # 静态资源
│   ├── components/          # 共享组件
│   │   ├── ui/             # Shadcn UI 基础组件
│   │   ├── layout/         # 布局组件
│   │   └── ...             # 其他共享组件
│   ├── config/             # 配置文件
│   ├── context/            # React Context
│   │   ├── theme-provider.tsx
│   │   ├── font-provider.tsx
│   │   └── direction-provider.tsx
│   ├── features/           # 功能模块（按业务领域划分）
│   │   ├── auth/          # 认证模块
│   │   ├── users/         # 用户管理
│   │   ├── roles/         # 角色管理
│   │   ├── domains/       # 域名管理
│   │   ├── dashboard/     # 仪表盘
│   │   └── ...
│   ├── hooks/             # 自定义 Hooks
│   ├── lib/               # 工具库
│   │   ├── adapters/     # 数据适配器（后端数据转换）
│   │   ├── services/     # API 服务层
│   │   ├── api-client.ts # HTTP 客户端配置
│   │   └── ...
│   ├── routes/            # 路由定义
│   │   ├── __root.tsx    # 根路由
│   │   ├── _authenticated/ # 需要认证的路由
│   │   ├── (auth)/       # 认证相关路由
│   │   └── ...
│   ├── stores/            # 状态管理（Zustand）
│   │   └── auth-store.ts # 认证状态
│   ├── styles/            # 全局样式
│   ├── main.tsx          # 应用入口
│   └── routeTree.gen.ts  # 自动生成的路由树
├── public/                # 公共资源
├── index.html            # HTML 模板
├── vite.config.ts        # Vite 配置
├── tsconfig.json         # TypeScript 配置
└── package.json          # 项目依赖
```

### 3.2 架构设计原则

#### 3.2.1 功能模块化（Feature-based）

每个功能模块（`features/`）包含完整的业务逻辑：

- `data/` - 数据模型和 Schema
- `components/` - 模块专用组件
- `hooks/` - 模块专用 Hooks
- `services/` - 模块 API 调用（可选，通常放在 `lib/services/`）

**优势**：

- 高内聚、低耦合
- 易于维护和测试
- 支持按需加载

#### 3.2.2 分层架构

```
┌─────────────────────────────────────┐
│         Presentation Layer          │ 组件层（UI）
│    (Components, Pages, Routes)     │
├─────────────────────────────────────┤
│          Business Logic            │ 业务逻辑层
│    (Hooks, Stores, Adapters)       │
├─────────────────────────────────────┤
│          Data Access Layer          │ 数据访问层
│    (Services, API Client)          │
└─────────────────────────────────────┘
```

#### 3.2.3 适配器模式

使用适配器模式（`lib/adapters/`）将后端数据格式转换为前端数据格式：

- **后端格式**：`ACTIVE`/`INACTIVE`、`records` 字段
- **前端格式**：`active`/`inactive`、`users` 字段

**优势**：

- 前后端解耦
- 易于处理 API 变更
- 统一的数据转换逻辑

## 4. 核心功能实现

### 4.1 认证系统

#### 4.1.1 认证流程

1. **登录**：用户输入邮箱/密码 → 调用登录 API → 获取令牌
2. **令牌存储**：将 `access_token`、`refresh_token`、`session_token` 存储到 Cookie
3. **请求拦截**：自动在请求头添加 `Authorization: Bearer {access_token}`
4. **令牌刷新**：当 `access_token` 过期（401）时，自动使用 `refresh_token` 刷新
5. **登出**：清除所有令牌和用户数据

#### 4.1.2 状态管理

使用 Zustand 管理认证状态（`stores/auth-store.ts`）：

```typescript
interface AuthState {
  auth: {
    user: AuthUser | null
    accessToken: string
    refreshToken: string
    sessionToken: string
    // ... 操作方法
  }
}
```

**特性**：

- 状态持久化（Cookie）
- 类型安全
- 轻量级（无需 Provider）

#### 4.1.3 路由保护

使用 TanStack Router 的路由守卫实现认证保护：

- `_authenticated/` 目录下的路由需要认证
- 未认证用户自动重定向到登录页
- 支持重定向回原始页面

### 4.2 API 客户端

#### 4.2.1 配置（`lib/api-client.ts`）

**基础配置**：

- 基础 URL：从环境变量 `VITE_API_BASE_URL` 读取
- 超时时间：30 秒
- 默认请求头：`Content-Type: application/json`

#### 4.2.2 请求拦截器

**功能**：

1. 自动添加认证令牌到请求头
2. 登录请求自动添加设备信息（设备类型、操作系统、浏览器等）
3. 开发环境请求日志

#### 4.2.3 响应拦截器

**功能**：

1. **数据提取**：自动提取 `response.data.data`（适配后端响应格式）
2. **令牌刷新**：
   - 检测 401 错误
   - 使用 `refresh_token` 刷新 `access_token`
   - 重试失败的请求
   - 处理并发请求（请求队列）
3. **错误处理**：统一处理网络错误、服务器错误

#### 4.2.4 错误处理

**错误类型**：

- **401**：未授权 → 自动刷新令牌或跳转登录
- **403**：权限不足 → 显示错误提示
- **500**：服务器错误 → 跳转错误页面（生产环境）
- **网络错误**：显示详细错误信息（开发环境）

### 4.3 数据获取（React Query）

#### 4.3.1 配置（`main.tsx`）

**查询配置**：

- **重试策略**：
  - 开发环境：不重试
  - 生产环境：最多 3 次，但 401/403 不重试
- **缓存策略**：
  - `staleTime`: 10 秒
  - `refetchOnWindowFocus`: 生产环境启用

**变更配置**：

- 统一错误处理
- 特殊处理 304 状态码（内容未修改）

#### 4.3.2 使用模式

```typescript
// 查询数据
const { data, isLoading, error } = useQuery({
  queryKey: ['users', page, size],
  queryFn: () => userService.getUsers({ page, size }),
})

// 变更数据
const mutation = useMutation({
  mutationFn: userService.updateUser,
  onSuccess: () => {
    queryClient.invalidateQueries({ queryKey: ['users'] })
  },
})
```

### 4.4 数据适配器

#### 4.4.1 设计目的

将后端数据格式转换为前端数据格式，实现前后端解耦。

#### 4.4.2 实现示例

**用户适配器**（`lib/adapters/user.adapter.ts`）：

- 状态映射：`ACTIVE` → `active`，`INACTIVE` → `inactive`
- 角色映射：后端角色代码 → 前端角色类型
- 分页格式：`records` → `users`

**角色适配器**（`lib/adapters/role.adapter.ts`）：

- 状态映射：`ENABLED` → `active`，`DISABLED` → `inactive`
- 日期转换：字符串 → Date 对象

### 4.5 表单处理

#### 4.5.1 技术栈

- **React Hook Form**：表单状态管理（性能优化）
- **Zod**：数据验证（类型安全）
- **@hookform/resolvers**：集成 React Hook Form 和 Zod

#### 4.5.2 使用模式

```typescript
// 定义 Schema
const userSchema = z.object({
  email: z.string().email('邮箱格式不正确'),
  password: z.string().min(8, '密码至少 8 位'),
})

// 使用表单
const form = useForm({
  resolver: zodResolver(userSchema),
  defaultValues: { email: '', password: '' },
})
```

## 5. 构建与部署

### 5.1 构建配置

#### 5.1.1 Vite 配置（`vite.config.ts`）

**插件**：

- `@tanstack/router-plugin`：路由代码生成
- `@vitejs/plugin-react-swc`：React 编译（SWC）
- `@tailwindcss/vite`：TailwindCSS 支持

**代码分割**：

- `react-vendor`：React 核心库
- `tanstack-vendor`：TanStack 相关库
- `ui-vendor`：UI 组件库
- `utils-vendor`：工具库

**路径别名**：

- `@/*` → `./src/*`

#### 5.1.2 TypeScript 配置

**应用配置**（`tsconfig.app.json`）：

- `target`: ES2020
- `module`: ESNext
- `moduleResolution`: Bundler
- `strict`: true
- `jsx`: react-jsx

**特性**：

- 严格类型检查
- 未使用变量/参数检查
- 路径别名支持

### 5.2 环境变量

**必需变量**：

- `VITE_API_BASE_URL`：API 基础地址（默认：`http://localhost:9528/v1`）

**使用方式**：

```typescript
import.meta.env.VITE_API_BASE_URL
```

### 5.3 构建命令

```bash
# 开发
pnpm dev

# 构建
pnpm build

# 预览构建结果
pnpm preview

# 代码检查
pnpm lint

# 代码格式化
pnpm format
```

### 5.4 部署

**构建产物**：

- 输出目录：`dist/`
- 静态资源：自动处理路径和文件名哈希

**部署平台**：

- 支持任何静态文件托管服务
- 配置示例：`netlify.toml`

## 6. 开发规范

### 6.1 代码规范

#### 6.1.1 命名规范

- **组件**：PascalCase（`UserList.tsx`）
- **文件**：kebab-case（`user-list.tsx`）或与组件名一致
- **函数/变量**：camelCase（`getUserList`）
- **常量**：UPPER_SNAKE_CASE（`API_BASE_URL`）
- **类型/接口**：PascalCase（`User`, `AuthState`）

#### 6.1.2 注释规范

遵循 TSDoc 规范，所有公共 API 必须包含完整注释：

```typescript
/**
 * 将后端用户属性转换为前端用户对象
 *
 * @param backendUser - 后端用户属性
 * @param roles - 用户角色列表（可选）
 * @returns 前端用户对象
 */
export function adaptBackendUserToFrontend(
  backendUser: BackendUserProperties,
  roles?: string[]
): User {
  // ...
}
```

#### 6.1.3 导入顺序

1. React 相关
2. 第三方库
3. 内部模块（`@/` 别名）
4. 相对路径导入
5. 类型导入（使用 `import type`）

### 6.2 文件组织

#### 6.2.1 组件文件

- 组件文件与目录同名
- 相关类型定义放在同目录或 `types.ts`
- 测试文件：`ComponentName.spec.ts`（同目录）

#### 6.2.2 功能模块

每个功能模块应包含：

- `data/schema.ts`：数据模型和 Zod Schema
- `components/`：模块专用组件
- `hooks/`：模块专用 Hooks（可选）

### 6.3 Git 提交规范

使用英文描述提交信息，遵循 Conventional Commits：

```
feat: 添加用户管理功能
fix: 修复登录令牌刷新问题
docs: 更新 API 文档
refactor: 重构数据适配器
```

## 7. 性能优化

### 7.1 代码分割

- **路由级别**：TanStack Router 自动代码分割
- **组件级别**：使用 `React.lazy()` 和 `Suspense`
- **构建优化**：Vite 配置手动代码分割（vendor chunks）

### 7.2 数据缓存

- **React Query**：自动缓存查询结果
- **缓存策略**：`staleTime` 10 秒，避免频繁请求

### 7.3 请求优化

- **请求去重**：React Query 自动去重相同查询
- **请求重试**：智能重试策略（排除 401/403）
- **乐观更新**：支持乐观更新提升用户体验

### 7.4 渲染优化

- **React 19**：自动批处理、并发渲染
- **React Hook Form**：减少不必要的重渲染
- **Memo 化**：合理使用 `React.memo`、`useMemo`、`useCallback`

## 8. 可访问性与国际化

### 8.1 可访问性（A11y）

- **Radix UI**：所有组件符合 WAI-ARIA 标准
- **键盘导航**：完整的键盘操作支持
- **屏幕阅读器**：语义化 HTML 和 ARIA 属性

### 8.2 国际化准备

- **RTL 支持**：已实现从右到左布局支持
- **主题切换**：支持深色/浅色主题
- **字体配置**：可配置字体族

## 9. 测试策略

### 9.1 测试类型

- **单元测试**：组件、工具函数（`*.spec.ts`）
- **集成测试**：功能模块（`tests/integration/`）
- **端到端测试**：用户流程（`tests/e2e/`）

### 9.2 测试工具

- **Vitest**：单元测试框架（推荐）
- **React Testing Library**：组件测试
- **Playwright**：E2E 测试（可选）

### 9.3 覆盖率要求

- **核心业务逻辑**：80% 以上
- **关键路径**：90% 以上
- **公共 API**：100% 覆盖

## 10. 安全考虑

### 10.1 认证安全

- **令牌存储**：使用 HttpOnly Cookie（建议）或安全的 Cookie 配置
- **令牌刷新**：自动刷新机制，避免令牌泄露
- **会话管理**：支持会话令牌，增强安全性

### 10.2 数据安全

- **输入验证**：使用 Zod Schema 验证所有用户输入
- **XSS 防护**：React 自动转义，避免直接使用 `dangerouslySetInnerHTML`
- **CSRF 防护**：使用令牌和 SameSite Cookie

### 10.3 网络安全

- **HTTPS**：生产环境强制使用 HTTPS
- **CORS**：正确配置 CORS 策略
- **请求超时**：设置合理的超时时间（30 秒）

## 11. 开发工具

### 11.1 开发环境工具

- **React Query Devtools**：查询调试
- **TanStack Router Devtools**：路由调试
- **React DevTools**：组件调试

### 11.2 代码质量工具

- **ESLint**：代码检查
- **Prettier**：代码格式化
- **Knip**：未使用代码检测
- **TypeScript**：类型检查

## 12. 未来规划

### 12.1 短期优化

- [ ] 完善单元测试覆盖
- [ ] 优化首屏加载时间
- [ ] 增强错误边界处理
- [ ] 完善国际化支持

### 12.2 长期规划

- [ ] 微前端架构探索
- [ ] PWA 支持
- [ ] 离线功能
- [ ] 性能监控集成

## 13. 参考资料

### 13.1 官方文档

- [React 19 文档](https://react.dev)
- [TanStack Router 文档](https://tanstack.com/router)
- [TanStack Query 文档](https://tanstack.com/query)
- [Vite 文档](https://vitejs.dev)
- [Shadcn UI 文档](https://ui.shadcn.com)

### 13.2 项目文档

- `README.md`：项目说明
- `架构文档.md`：架构设计文档
- `环境变量配置说明.md`：环境变量配置

---

**文档版本**：1.0.0  
**最后更新**：2024年  
**维护者**：hl8-saas-turbo 团队
