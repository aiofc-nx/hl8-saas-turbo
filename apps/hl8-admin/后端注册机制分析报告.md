# åç«¯æ³¨å†Œæœºåˆ¶åˆ†ææŠ¥å‘Š

## æ¦‚è¿°

åç«¯ç¡®å®æœ‰ç”¨æˆ·åˆ›å»ºåŠŸèƒ½ï¼Œä½†**ä¸æ˜¯å…¬å¼€çš„æ³¨å†Œæ¥å£**ï¼Œè€Œæ˜¯**éœ€è¦ç®¡ç†å‘˜æƒé™çš„ç”¨æˆ·ç®¡ç†æ¥å£**ã€‚

## å½“å‰å®ç°

### 1. ç”¨æˆ·åˆ›å»ºæ¥å£

**è·¯å¾„**: `POST /v1/user`  
**æ§åˆ¶å™¨**: `apps/admin-api/src/api/iam/rest/user.controller.ts`

```typescript
@Post()
@ApiOperation({ summary: 'Create a New User' })
async createUser(
  @Body() dto: UserCreateDto,
  @Request() req: any,
): Promise<ApiRes<null>>
```

**ç‰¹ç‚¹**:

- âŒ **éœ€è¦è®¤è¯**ï¼šæ²¡æœ‰ `@Public()` è£…é¥°å™¨ï¼Œå¿…é¡»å·²ç™»å½•
- âŒ **éœ€è¦æƒé™**ï¼šåªæœ‰ç®¡ç†å‘˜æ‰èƒ½åˆ›å»ºç”¨æˆ·
- âœ… **åŠŸèƒ½å®Œæ•´**ï¼šæ”¯æŒåˆ›å»ºç”¨æˆ·çš„æ‰€æœ‰å¿…è¦å­—æ®µ

### 2. ç”¨æˆ·åˆ›å»ºæµç¨‹

#### 2.1 è¯·æ±‚å‚æ•°ï¼ˆUserCreateDtoï¼‰

```typescript
{
  username: string;      // å¿…å¡«ï¼Œæœ€å°é•¿åº¦ 6
  password: string;      // å¿…å¡«ï¼Œæœ€å°é•¿åº¦ 6
  domain: string;        // å¿…å¡«ï¼Œç”¨æˆ·æ‰€å±åŸŸ
  nickName: string;      // å¿…å¡«ï¼Œç”¨æˆ·æ˜µç§°
  avatar?: string;       // å¯é€‰ï¼Œå¤´åƒ URL
  email?: string;        // å¯é€‰ï¼Œé‚®ç®±
  phoneNumber?: string;  // å¯é€‰ï¼Œæ‰‹æœºå·
}
```

#### 2.2 å¤„ç†æµç¨‹

1. **å‘½ä»¤åˆ›å»º** (`UserCreateCommand`)
   - æ¥æ”¶åˆ›å»ºå‚æ•°
   - åŒ…å«åˆ›å»ºè€… IDï¼ˆ`req.user.uid`ï¼‰

2. **å‘½ä»¤å¤„ç†** (`UserCreateHandler`)

   ```typescript
   async execute(command: UserCreateCommand) {
     // 1. éªŒè¯ç”¨æˆ·åå”¯ä¸€æ€§
     const existingUser = await this.userReadRepoPort.getUserByUsername(
       command.username
     );
     if (existingUser) {
       throw new BadRequestException(
         `A user with code ${command.username} already exists.`
       );
     }

     // 2. åŠ å¯†å¯†ç 
     const hashedPassword = await Password.hash(command.password);

     // 3. åˆ›å»ºç”¨æˆ·å±æ€§
     const userCreateProperties: UserCreateProperties = {
       id: UlidGenerator.generate(),
       username: command.username,
       nickName: command.nickName,
       password: hashedPassword.getValue(),
       domain: command.domain,
       status: Status.ENABLED,
       avatar: command.avatar,
       email: command.email,
       phoneNumber: command.phoneNumber,
       createdAt: new Date(),
       createdBy: command.uid,
     };

     // 4. åˆ›å»ºç”¨æˆ·èšåˆæ ¹
     const user = new User(userCreateProperties);

     // 5. ä¿å­˜åˆ°æ•°æ®åº“
     await this.userWriteRepository.save(user);

     // 6. å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
     await user.created();
     this.publisher.mergeObjectContext(user);
     user.commit();
   }
   ```

3. **äº‹ä»¶å¤„ç†** (`UserCreatedHandler`)
   - ç›‘å¬ `UserCreatedEvent`
   - å½“å‰ä»…è®°å½•æ—¥å¿—ï¼Œå¯æ‰©å±•ç”¨äºå‘é€æ¬¢è¿é‚®ä»¶ç­‰

### 3. å¯†ç åŠ å¯†

**å®ç°**: `apps/admin-api/src/lib/bounded-contexts/iam/authentication/domain/password.value-object.ts`

- ä½¿ç”¨ **bcrypt** è¿›è¡Œå¯†ç å“ˆå¸Œ
- è‡ªåŠ¨ç”Ÿæˆ salt
- æä¾›å¯†ç éªŒè¯æ–¹æ³•

```typescript
static async hash(password: string): Promise<Password> {
  const salt = await bcrypt.genSalt();
  const hashedPassword = await bcrypt.hash(password, salt);
  return new Password(hashedPassword);
}
```

### 4. éªŒè¯è§„åˆ™

- **ç”¨æˆ·å**: æœ€å°é•¿åº¦ 6 å­—ç¬¦ï¼Œåœ¨åŸŸå†…å¿…é¡»å”¯ä¸€
- **å¯†ç **: æœ€å°é•¿åº¦ 6 å­—ç¬¦
- **åŸŸ**: å¿…å¡«ï¼Œç”¨äºå¤šç§Ÿæˆ·éš”ç¦»
- **æ˜µç§°**: å¿…å¡«

## é—®é¢˜åˆ†æ

### ä¸ºä»€ä¹ˆå‰ç«¯æ— æ³•ä½¿ç”¨ï¼Ÿ

1. **æ¥å£éœ€è¦è®¤è¯**
   - `POST /v1/user` éœ€è¦ç™»å½•
   - å‰ç«¯æ³¨å†Œæ—¶ç”¨æˆ·å°šæœªç™»å½•ï¼Œæ— æ³•è°ƒç”¨

2. **ç¼ºå°‘å…¬å¼€æ³¨å†Œæ¥å£**
   - åç«¯æ²¡æœ‰ `POST /v1/auth/register` æ¥å£
   - å‰ç«¯æœŸæœ›çš„æ³¨å†Œæ¥å£ä¸å­˜åœ¨

3. **è®¾è®¡ç†å¿µä¸åŒ**
   - åç«¯è®¾è®¡ï¼šç”¨æˆ·ç”±ç®¡ç†å‘˜åˆ›å»ºï¼ˆä¼ä¸šçº§ SaaS æ¨¡å¼ï¼‰
   - å‰ç«¯æœŸæœ›ï¼šç”¨æˆ·è‡ªä¸»æ³¨å†Œï¼ˆå…¬å¼€æ³¨å†Œæ¨¡å¼ï¼‰

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ·»åŠ å…¬å¼€æ³¨å†Œæ¥å£ï¼ˆæ¨èï¼‰

åœ¨åç«¯ `AuthenticationController` ä¸­æ·»åŠ å…¬å¼€æ³¨å†Œæ¥å£ï¼š

```typescript
@Public()
@Post('register')
@ApiOperation({ summary: 'User Registration' })
async register(
  @Body() dto: RegisterDto,
  @Request() request: FastifyRequest,
): Promise<ApiRes<any>> {
  // 1. éªŒè¯é‚®ç®±å”¯ä¸€æ€§
  // 2. åˆ›å»ºç”¨æˆ·ï¼ˆä½¿ç”¨é»˜è®¤åŸŸæˆ–é…ç½®çš„å…¬å¼€åŸŸï¼‰
  // 3. å‘é€é‚®ç®±éªŒè¯ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
  // 4. è¿”å›æˆåŠŸæ¶ˆæ¯
}
```

**ä¼˜ç‚¹**:

- âœ… ç¬¦åˆå‰ç«¯æœŸæœ›
- âœ… æ”¯æŒå…¬å¼€æ³¨å†Œ
- âœ… å¯ä»¥æ·»åŠ é‚®ç®±éªŒè¯æµç¨‹

**ç¼ºç‚¹**:

- âš ï¸ éœ€è¦ç¡®å®šé»˜è®¤åŸŸæˆ–å…¬å¼€åŸŸ
- âš ï¸ éœ€è¦å®ç°é‚®ç®±éªŒè¯ç å‘é€

### æ–¹æ¡ˆ 2: ä½¿ç”¨ç°æœ‰æ¥å£ + ä¸´æ—¶ç®¡ç†å‘˜è´¦æˆ·

åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç®¡ç†å‘˜è´¦æˆ·ï¼Œå‰ç«¯ä½¿ç”¨è¯¥è´¦æˆ·çš„ token è°ƒç”¨ `/v1/user`ã€‚

**ç¼ºç‚¹**:

- âŒ å®‰å…¨æ€§å·®
- âŒ ä¸ç¬¦åˆè®¾è®¡ç†å¿µ
- âŒ éš¾ä»¥ç®¡ç†

### æ–¹æ¡ˆ 3: ä¿æŒå½“å‰è®¾è®¡

å‰ç«¯ç¦ç”¨æ³¨å†ŒåŠŸèƒ½ï¼Œç”¨æˆ·åªèƒ½ç”±ç®¡ç†å‘˜åˆ›å»ºã€‚

**ä¼˜ç‚¹**:

- âœ… ç¬¦åˆä¼ä¸šçº§ SaaS è®¾è®¡
- âœ… å®‰å…¨æ€§é«˜
- âœ… ç”¨æˆ·è´¨é‡å¯æ§

**ç¼ºç‚¹**:

- âŒ ä¸æ”¯æŒå…¬å¼€æ³¨å†Œ
- âŒ ç”¨æˆ·ä½“éªŒå—é™

## æ¨èå®ç°æ–¹æ¡ˆ

### å®ç°å…¬å¼€æ³¨å†Œæ¥å£

1. **åˆ›å»ºæ³¨å†Œ DTO**

   ```typescript
   export class RegisterDto {
     @IsEmail()
     email: string;

     @MinLength(6)
     password: string;

     @IsOptional()
     username?: string; // å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é‚®ç®±

     @IsOptional()
     nickName?: string; // å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨é‚®ç®±å‰ç¼€
   }
   ```

2. **æ·»åŠ æ³¨å†Œæ¥å£**

   ```typescript
   @Public()
   @Post('register')
   async register(@Body() dto: RegisterDto): Promise<ApiRes<any>> {
     // 1. æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²æ³¨å†Œ
     // 2. ç”Ÿæˆç”¨æˆ·åï¼ˆå¦‚æœæœªæä¾›ï¼‰
     // 3. ä½¿ç”¨é»˜è®¤åŸŸæˆ–é…ç½®çš„å…¬å¼€åŸŸ
     // 4. åˆ›å»ºç”¨æˆ·
     // 5. å‘é€é‚®ç®±éªŒè¯ç ï¼ˆå¯é€‰ï¼‰
     // 6. è¿”å›æˆåŠŸæ¶ˆæ¯
   }
   ```

3. **é…ç½®é»˜è®¤åŸŸ**
   - åœ¨ç¯å¢ƒå˜é‡ä¸­æ·»åŠ  `PUBLIC_REGISTER_DOMAIN`
   - æˆ–ä½¿ç”¨ç³»ç»Ÿé»˜è®¤åŸŸ

4. **é‚®ç®±éªŒè¯ï¼ˆå¯é€‰ï¼‰**
   - æ³¨å†Œåå‘é€éªŒè¯ç 
   - ç”¨æˆ·éªŒè¯é‚®ç®±åæ‰èƒ½ç™»å½•

## æ€»ç»“

- âœ… åç«¯æœ‰å®Œæ•´çš„ç”¨æˆ·åˆ›å»ºåŠŸèƒ½
- âŒ ä½†éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œä¸æ”¯æŒå…¬å¼€æ³¨å†Œ
- ğŸ’¡ å»ºè®®æ·»åŠ å…¬å¼€æ³¨å†Œæ¥å£ä»¥æ”¯æŒå‰ç«¯éœ€æ±‚
- ğŸ”’ éœ€è¦è€ƒè™‘å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒçš„å¹³è¡¡
