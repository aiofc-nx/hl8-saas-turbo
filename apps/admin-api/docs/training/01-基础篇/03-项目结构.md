# 项目结构

## 学习目标

- 理解项目的目录层次结构
- 理解各层的职责
- 理解有界上下文的组织方式

## 1. 目录层次结构

```
apps/admin-api/src/
├── api/                          # 接口层 (Presentation Layer)
│   ├── iam/                      # IAM 相关 REST API
│   │   ├── rest/                 # REST 控制器
│   │   └── dto/                  # 数据传输对象
│   ├── access-key/                # 访问密钥 API
│   ├── endpoint/                  # API 端点 API
│   └── log-audit/                 # 审计日志 API
│
├── lib/                           # 业务逻辑层 (Business Logic Layer)
│   ├── bounded-contexts/          # 有界上下文
│   │   ├── iam/                   # IAM 上下文
│   │   │   ├── authentication/   # 认证子上下文
│   │   │   │   ├── application/   # 应用层
│   │   │   │   │   ├── command-handlers/  # 命令处理器
│   │   │   │   │   ├── query-handlers/    # 查询处理器
│   │   │   │   │   ├── event-handlers/    # 事件处理器
│   │   │   │   │   └── service/           # 应用服务
│   │   │   │   ├── commands/              # 命令定义
│   │   │   │   ├── queries/               # 查询定义
│   │   │   │   ├── domain/                # 领域层
│   │   │   │   │   ├── user.ts            # 用户聚合根
│   │   │   │   │   ├── user.read.model.ts # 用户读模型
│   │   │   │   │   ├── password.value-object.ts # 密码值对象
│   │   │   │   │   └── events/            # 领域事件
│   │   │   │   └── ports/                 # 端口接口
│   │   │   │       ├── user.read.repo-port.ts   # 读仓储接口
│   │   │   │       └── user.write.repo-port.ts  # 写仓储接口
│   │   │   ├── domain/            # 域管理
│   │   │   ├── menu/              # 菜单管理
│   │   │   ├── role/              # 角色管理
│   │   │   └── tokens/            # 令牌管理
│   │   ├── access-key/            # 访问密钥上下文
│   │   ├── api-endpoint/         # API 端点上下文
│   │   └── log-audit/            # 审计日志上下文
│   └── shared/                    # 共享资源
│       ├── enums/                # 枚举定义
│       └── constants/            # 常量定义
│
├── infra/                         # 基础设施层 (Infrastructure Layer)
│   └── bounded-contexts/          # 基础设施实现
│       ├── iam/                   # IAM 基础设施
│       │   ├── authentication/   # 认证基础设施
│       │   │   ├── repository/   # 仓储实现
│       │   │   │   ├── user.read.pg.repository.ts   # 读仓储实现
│       │   │   │   └── user.write.pg.repository.ts  # 写仓储实现
│       │   │   └── iam.module.ts # 模块配置
│       │   ├── domain/            # 域基础设施
│       │   ├── menu/              # 菜单基础设施
│       │   ├── role/              # 角色基础设施
│       │   └── tokens/            # 令牌基础设施
│       ├── access-key/            # 访问密钥基础设施
│       ├── api-endpoint/          # API 端点基础设施
│       └── log-audit/             # 审计日志基础设施
│
├── app.module.ts                  # 根模块
├── main.ts                         # 应用入口
└── resources/                      # 静态资源
```

## 2. 各层职责

### 2.1 接口层（API Layer）- `src/api/`

**职责**：

- 接收 HTTP 请求
- 参数验证和转换 (DTO)
- 调用 CQRS 的 CommandBus/QueryBus
- 返回 HTTP 响应

**特点**：

- 使用 NestJS 的 `@Controller` 装饰器
- 通过 `CommandBus` 和 `QueryBus` 与业务层交互
- 不包含业务逻辑，只负责协议转换

### 2.2 应用层（Application Layer）- `src/lib/bounded-contexts/{context}/application/`

**职责**：

- 实现业务用例（Use Case）
- 编排领域对象完成业务用例
- 处理命令和查询（CQRS）
- 处理领域事件

**组件**：

- **Command Handlers**：处理写操作命令
- **Query Handlers**：处理读操作查询
- **Event Handlers**：处理领域事件
- **Application Services**：复杂的业务用例编排
- **Ports**：端口接口定义

### 2.3 领域层（Domain Layer）- `src/lib/bounded-contexts/{context}/domain/`

**职责**：

- 核心业务逻辑
- 业务规则和约束
- 领域模型定义

**组件**：

- **聚合根（Aggregate Root）**：业务实体
- **值对象（Value Object）**：无标识的对象
- **领域事件（Domain Event）**：业务事件
- **读模型（Read Model）**：查询优化的数据模型

### 2.4 基础设施层（Infrastructure Layer）- `src/infra/`

**职责**：

- 实现端口接口
- 与外部系统交互
- 技术细节实现

**组件**：

- **仓储实现（Repository Implementations）**：实现端口接口
- **模块配置（Module Configuration）**：依赖注入配置

## 3. 有界上下文组织

### 3.1 有界上下文概念

**定义**：表示一个业务边界，在这个边界内，领域模型有明确的含义。

**项目中的有界上下文**：

- **IAM 上下文**：身份认证与授权
  - authentication：用户认证
  - domain：域管理
  - menu：菜单管理
  - role：角色管理
  - tokens：令牌管理
- **Access Key 上下文**：访问密钥管理
- **API Endpoint 上下文**：API 端点管理
- **Log Audit 上下文**：审计日志
  - login-log：登录日志
  - operation-log：操作日志

### 3.2 有界上下文结构

每个有界上下文都包含：

```
{context}/
├── application/          # 应用层
│   ├── command-handlers/
│   ├── query-handlers/
│   ├── event-handlers/
│   └── service/
├── commands/             # 命令定义
├── queries/              # 查询定义
├── domain/               # 领域层
│   ├── {aggregate}.ts   # 聚合根
│   ├── {aggregate}.read.model.ts  # 读模型
│   ├── {value-object}.value-object.ts  # 值对象
│   └── events/          # 领域事件
└── ports/               # 端口接口
    ├── {module}.read.repo-port.ts
    └── {module}.write.repo-port.ts
```

## 4. 依赖关系

### 4.1 依赖方向

```
Infrastructure Layer (基础设施层)
   ↓ (依赖)
Application Layer (应用层，包含 Ports)
   ↓ (依赖)
Domain Layer (领域层)
```

### 4.2 模块依赖

```
AppModule
   ↓
ApiModule
   ↓
InfraModule (各个上下文的基础设施模块)
   ↓
ApplicationModule (各个上下文的应用模块)
   ↓
Domain (领域模型，无依赖)
```

## 5. 学习检查

完成本章学习后，请回答以下问题：

1. 项目的三层架构是什么？
2. 各层的职责是什么？
3. 有界上下文如何组织？
4. 依赖方向是什么？

## 6. 下一步

- 学习 [开发流程指南](../03-实践篇/01-开发流程指南.md)
- 查看 [IAM-API 架构设计文档](../../IAM-API-ARCHITECTURE.md)

---

**上一章**：[核心概念](./02-核心概念.md)  
**下一章**：[开发流程指南](../03-实践篇/01-开发流程指南.md)  
**返回**：[培训大纲](../README.md)
