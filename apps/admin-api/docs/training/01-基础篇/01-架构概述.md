# 架构概述

## 学习目标

- 理解项目的架构目标和原则
- 了解三种架构模式的基本概念
- 理解架构带来的优势

## 1. 架构目标

`admin-api` 项目采用 **Clean Architecture + CQRS + 事件驱动架构（EDA）** 的组合架构模式，旨在实现以下目标：

### 1.1 高内聚、低耦合

通过分层架构和清晰的边界，确保各层职责明确，降低依赖关系。

**示例**：

- 领域层不依赖基础设施层
- 应用层通过端口接口访问基础设施
- 各层职责单一，边界清晰

### 1.2 业务逻辑独立

核心业务逻辑不依赖技术框架和基础设施，易于测试和维护。

**优势**：

- 可以替换数据库（PostgreSQL → MongoDB，ORM 保持不变，依然使用 MikroORM）
- 可以替换 ORM 框架（MikroORM → TypeORM）
- 业务逻辑可以独立测试

**实际案例**：

- 未来计划将数据库从 PostgreSQL 迁移到 MongoDB
- 由于架构设计，只需要修改基础设施层的适配器实现
- 应用层和领域层代码无需修改
- ORM 框架（MikroORM）支持 MongoDB，配置修改即可

### 1.3 读写分离

通过 CQRS 实现读写操作的优化和独立扩展。

**优势**：

- 读操作和写操作可以独立优化
- 可以为读写操作使用不同的数据库
- 提升系统性能和可扩展性

### 1.4 事件驱动

通过领域事件实现模块间解耦和异步处理，提升系统响应性和可扩展性。

**优势**：

- 模块间解耦
- 异步处理提升响应性
- 易于扩展新功能

### 1.5 可测试性

清晰的依赖方向使得单元测试和集成测试更容易编写。

**优势**：

- 领域层可以独立测试
- 可以通过 Mock 接口测试应用层
- 测试覆盖率高

## 2. 架构原则

### 2.1 依赖倒置原则（DIP）

**定义**：高层模块不依赖低层模块，两者都依赖抽象。

**在项目中的应用**：

- 应用层定义端口接口（抽象）
- 基础设施层实现适配器（具体）
- 应用层不直接依赖基础设施层

### 2.2 单一职责原则（SRP）

**定义**：每个类或模块只有一个变化的理由。

**在项目中的应用**：

- Command Handler 只处理命令
- Query Handler 只处理查询
- 聚合根只包含业务逻辑

### 2.3 开闭原则（OCP）

**定义**：对扩展开放，对修改关闭。

**在项目中的应用**：

- 通过端口接口扩展功能
- 新增仓储实现无需修改业务逻辑
- 新增事件处理器不影响现有代码

### 2.4 关注点分离

**定义**：将业务逻辑、技术细节、基础设施分开处理。

**在项目中的应用**：

- 领域层：业务逻辑
- 应用层：用例编排
- 基础设施层：技术实现

## 3. 四种架构模式简介

### 3.1 Clean Architecture（清洁架构）

**核心思想**：依赖规则 - 源代码依赖只能指向内层，外层依赖内层，内层不依赖外层。

**分层结构**：

```
Infrastructure Layer (基础设施层)
   ↓
Application Layer (应用层)
   ↓
Domain Layer (领域层)
```

**关键特点**：

- 领域层独立于技术框架
- 通过端口适配器模式解耦
- 依赖方向清晰

### 3.2 CQRS（命令查询职责分离）

**核心思想**：将写操作（命令）和读操作（查询）完全分离。

**分离方式**：

- **命令（Command）**：修改系统状态，返回 void
- **查询（Query）**：读取数据，不修改状态

**关键特点**：

- 读写操作独立优化
- 可以为读写操作使用不同的数据模型
- 提升系统性能和可扩展性

### 3.3 事件驱动架构（EDA）

**核心思想**：通过领域事件实现模块间解耦和异步处理。

**关键组件**：

- **领域事件**：表示领域内发生的业务事件
- **事件发布**：聚合根发布事件
- **事件处理**：事件处理器异步处理事件

**关键特点**：

- 模块间解耦
- 异步处理
- 最终一致性

### 3.4 事件溯源（Event Sourcing, ES）

**核心思想**：不存储当前状态，而是存储所有发生的事件，通过重放事件来重建当前状态。

**关键组件**：

- **事件存储（Event Store）**：存储所有领域事件
- **状态重建**：通过重放事件重建聚合根状态
- **快照（Snapshot）**：定期创建快照，优化重建性能

**关键特点**：

- 完整的历史记录
- 时间旅行功能
- 完整的审计日志
- 与 CQRS 完美结合

**详细说明**：请参阅 [事件溯源详解](../02-进阶篇/04-事件溯源详解.md)

## 4. 架构优势总结

### 4.1 技术优势

- ✅ **独立于框架**：可以替换框架而不影响业务逻辑
- ✅ **独立于数据库**：可以替换数据库而不影响业务逻辑
- ✅ **独立于 UI**：可以替换 UI 而不影响业务逻辑
- ✅ **独立于外部服务**：可以替换外部服务而不影响业务逻辑

### 4.2 业务优势

- ✅ **业务逻辑集中**：核心业务逻辑集中在领域层
- ✅ **易于理解**：清晰的架构层次，易于理解业务
- ✅ **易于维护**：职责清晰，易于维护和扩展
- ✅ **易于测试**：清晰的依赖方向，易于编写测试

### 4.3 团队优势

- ✅ **协作效率高**：清晰的架构边界，减少冲突
- ✅ **知识传递快**：统一的架构模式，易于知识传递
- ✅ **代码质量高**：架构约束保证代码质量
- ✅ **扩展性强**：易于添加新功能和模块

## 5. 架构适用场景

这种架构特别适合：

- ✅ **复杂的业务领域**：业务逻辑复杂，需要清晰的架构
- ✅ **需要长期维护的系统**：架构稳定，易于维护
- ✅ **团队协作开发**：清晰的边界，减少冲突
- ✅ **需要高可测试性的项目**：易于编写测试
- ✅ **需要高可扩展性的系统**：易于扩展新功能
- ✅ **需要事件驱动的异步处理场景**：通过事件实现解耦

## 6. 学习检查

完成本章学习后，请回答以下问题：

1. 项目的架构目标是什么？
2. 依赖倒置原则在项目中如何应用？
3. Clean Architecture 的核心思想是什么？
4. CQRS 如何实现读写分离？
5. 事件驱动架构的优势是什么？

## 7. 下一步

- 学习 [核心概念](./02-核心概念.md)
- 查看 [架构原理文档](../../ARCHITECTURE.md)

---

**下一章**：[核心概念](./02-核心概念.md)  
**返回**：[培训大纲](../README.md)
