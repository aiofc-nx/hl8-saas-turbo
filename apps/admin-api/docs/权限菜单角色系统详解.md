# 权限、菜单、角色系统详解

## 目录

1. [系统概述](#系统概述)
2. [架构设计](#架构设计)
3. [角色系统](#角色系统)
4. [菜单系统](#菜单系统)
5. [权限系统](#权限系统)
6. [系统集成](#系统集成)
7. [使用指南](#使用指南)
8. [最佳实践](#最佳实践)

---

## 系统概述

### 1.1 系统定位

权限、菜单、角色系统是 IAM（身份与访问管理）有界上下文的核心组成部分，采用基于角色的访问控制（RBAC）模型，实现了完整的权限管理体系。

### 1.2 核心组件

系统由三个核心模块组成：

- **角色系统（Role）**：权限管理的基础单位，通过角色组织和管理用户权限
- **菜单系统（Menu）**：前端路由和菜单的生命周期管理，支持树形结构和权限控制
- **权限系统（Permission）**：基于 Casbin 的权限策略管理，实现细粒度的 API 访问控制

### 1.3 技术架构

- **架构模式**：Clean Architecture + CQRS + 事件驱动架构（EDA）
- **权限引擎**：Casbin RBAC 模型
- **数据存储**：PostgreSQL（关系数据）+ Casbin（权限策略）
- **缓存策略**：Redis（用户角色缓存）

---

## 架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      API 层 (REST Controllers)                │
├─────────────────────────────────────────────────────────────┤
│  RoleController  │  MenuController  │  AuthorizationController │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Services)              │
├─────────────────────────────────────────────────────────────┤
│  RoleService  │  MenuService  │  AuthorizationService         │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                     领域层 (Domain Models)                    │
├─────────────────────────────────────────────────────────────┤
│  Role  │  Menu  │  User  │  Domain                           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                   基础设施层 (Infrastructure)                  │
├─────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  Casbin  │  Redis                              │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据模型关系

```
┌──────────┐         ┌──────────────┐         ┌──────────┐
│   User   │────────▶│ sys_user_role │────────▶│   Role   │
└──────────┘         └──────────────┘         └──────────┘
                                                      │
                                                      │
                                              ┌──────────────┐
                                              │ sys_role_menu│
                                              └──────────────┘
                                                      │
                                                      ▼
                                                ┌──────────┐
                                                │   Menu   │
                                                └──────────┘

┌──────────┐         ┌──────────────────┐
│   Role   │────────▶│  Casbin Policy   │
└──────────┘         │  (权限策略)      │
                     └──────────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │ API Endpoint │
                     └──────────────┘
```

### 2.3 权限验证流程

```
用户请求
    ↓
JWT Token 验证
    ↓
提取用户信息（userId, domain, roles）
    ↓
查询用户角色（从 Redis 缓存或数据库）
    ↓
Casbin 权限验证
    ├─→ 通过 → 执行请求
    └─→ 拒绝 → 返回 403 Forbidden
```

---

## 角色系统

### 3.1 角色模型

角色是权限管理的基础单位，每个角色具有以下属性：

| 属性          | 类型             | 说明                   | 约束                   |
| ------------- | ---------------- | ---------------------- | ---------------------- |
| `id`          | `string`         | 角色唯一标识符（ULID） | 必填，唯一             |
| `code`        | `string`         | 角色代码，用于权限策略 | 必填，全局唯一         |
| `name`        | `string`         | 角色显示名称           | 必填                   |
| `pid`         | `string`         | 父角色 ID              | 必填，根角色为 `'0'`   |
| `status`      | `Status`         | 角色状态               | `ENABLED` / `DISABLED` |
| `description` | `string \| null` | 角色描述               | 可选                   |

### 3.2 角色层级结构

角色支持父子层级关系，通过 `pid` 字段实现：

```
系统管理员 (pid: '0')
  ├── 业务管理员 (pid: '系统管理员ID')
  │   ├── 业务专员 (pid: '业务管理员ID')
  │   └── 业务审核员 (pid: '业务管理员ID')
  └── 运营管理员 (pid: '系统管理员ID')
      └── 运营专员 (pid: '运营管理员ID')
```

**业务规则**：

- 根角色：`pid` 为 `ROOT_PID`（即 `'0'`）
- 循环引用防止：角色不能将自己的 ID 设置为父角色 ID
- 层级深度：理论上支持无限层级，建议控制在 3-4 层

### 3.3 角色管理 API

#### 3.3.1 创建角色

```http
POST /role
Content-Type: application/json

{
  "code": "admin",
  "name": "管理员",
  "pid": "0",
  "status": "ENABLED",
  "description": "系统管理员角色"
}
```

**业务规则**：

- 角色代码必须全局唯一
- 如果指定了父角色，父角色必须存在
- 创建成功后自动生成 ULID 作为角色 ID

#### 3.3.2 更新角色

```http
PUT /role
Content-Type: application/json

{
  "id": "role-id-123",
  "code": "admin",
  "name": "系统管理员",
  "pid": "0",
  "status": "ENABLED",
  "description": "更新后的描述"
}
```

**业务规则**：

- 角色代码唯一性验证（排除当前角色）
- 防止循环引用
- 更新审计信息（updatedAt, updatedBy）

#### 3.3.3 删除角色

```http
DELETE /role/{id}
```

**业务规则**：

- 删除角色前应确保角色下没有关联的用户
- 删除后自动触发 `RoleDeletedEvent` 事件
- 自动清理该角色的所有 Casbin 权限策略
- 自动删除角色的菜单关联关系

#### 3.3.4 分页查询角色

```http
GET /role?current=1&size=10&code=admin&name=管理员&status=ENABLED
```

**查询参数**：

- `current`: 当前页码
- `size`: 每页大小
- `code`: 角色代码（模糊查询）
- `name`: 角色名称（模糊查询）
- `status`: 角色状态（精确匹配）

---

## 菜单系统

### 4.1 菜单模型

菜单用于前端路由渲染和权限控制，支持树形结构：

| 属性        | 类型       | 说明                     | 约束                            |
| ----------- | ---------- | ------------------------ | ------------------------------- |
| `id`        | `number`   | 菜单唯一标识符（自增ID） | 必填，唯一                      |
| `menuName`  | `string`   | 菜单显示名称             | 必填                            |
| `menuType`  | `MenuType` | 菜单类型                 | `MENU` / `DIRECTORY` / `BUTTON` |
| `routeName` | `string`   | 前端路由名称             | 必填，唯一                      |
| `routePath` | `string`   | 前端路由路径             | 必填                            |
| `component` | `string`   | 前端组件路径             | 必填                            |
| `pid`       | `number`   | 父菜单 ID                | 必填，根菜单为 `0`              |
| `order`     | `number`   | 显示顺序                 | 必填，数字越小越靠前            |
| `constant`  | `boolean`  | 是否常量路由             | 必填，常量路由不受权限控制      |
| `status`    | `Status`   | 菜单状态                 | `ENABLED` / `DISABLED`          |

### 4.2 菜单类型

菜单支持三种类型：

- **MENU（菜单）**：可点击的菜单项，通常对应一个路由页面
- **DIRECTORY（目录）**：目录节点，用于组织菜单结构，本身不可点击
- **BUTTON（按钮）**：按钮权限，用于控制页面内的操作按钮权限，不在菜单中显示

### 4.3 菜单层级结构

菜单支持父子层级关系，通过 `pid` 字段实现：

```
根菜单 (pid: 0)
  ├── 系统设置 (pid: 根菜单ID, DIRECTORY)
  │   ├── 用户管理 (pid: 系统设置ID, MENU)
  │   ├── 角色管理 (pid: 系统设置ID, MENU)
  │   └── 菜单管理 (pid: 系统设置ID, MENU)
  └── 业务管理 (pid: 根菜单ID, DIRECTORY)
      ├── 订单管理 (pid: 业务管理ID, MENU)
      └── 商品管理 (pid: 业务管理ID, MENU)
```

### 4.4 常量路由

常量路由（`constant: true`）不受权限控制，所有用户都可以访问，适用于：

- 系统公共页面（登录页、错误页等）
- 不需要权限验证的路由

### 4.5 菜单管理 API

#### 4.5.1 创建菜单

```http
POST /route
Content-Type: application/json

{
  "menuName": "用户管理",
  "menuType": "MENU",
  "routeName": "user-management",
  "routePath": "/user",
  "component": "UserManagement",
  "pid": 0,
  "order": 1,
  "constant": false,
  "status": "ENABLED"
}
```

#### 4.5.2 获取菜单树

```http
GET /route/tree?constant=false
```

**查询参数**：

- `constant`: 是否只查询常量路由（默认 `false`）

**返回**：树形结构的菜单数组

#### 4.5.3 获取用户路由

```http
GET /authorization/getUserRoutes
```

**说明**：

- 根据当前登录用户的角色和域获取可访问的菜单
- 返回路由树和首页路径
- 用于前端菜单渲染和路由守卫

---

## 权限系统

### 5.1 权限模型

权限系统基于 Casbin RBAC 模型，权限策略格式为：

```
p, roleCode, resource, action, domain, 'allow'
```

**参数说明**：

- `roleCode`: 角色代码
- `resource`: 资源类型（如 `user`、`role`、`domain`）
- `action`: 操作类型（如 `read`、`write`、`delete`）
- `domain`: 域代码（多租户隔离）
- `'allow'`: 允许访问

### 5.2 API 端点权限

API 端点权限通过 `sys_endpoint` 表管理：

| 字段         | 类型     | 说明           |
| ------------ | -------- | -------------- |
| `id`         | `string` | 端点唯一标识符 |
| `path`       | `string` | API 路径       |
| `method`     | `string` | HTTP 方法      |
| `resource`   | `string` | 资源类型       |
| `action`     | `string` | 操作类型       |
| `controller` | `string` | 控制器名称     |

### 5.3 权限验证机制

#### 5.3.1 装饰器使用

在控制器方法上使用 `@UsePermissions` 装饰器声明权限要求：

```typescript
@Controller('user')
@UseGuards(AuthZGuard)
export class UserController {
  @Get()
  @UsePermissions({ resource: 'user', action: AuthActionVerb.READ })
  async getUsers() {
    // 需要 'user:read' 权限
  }

  @Post()
  @UsePermissions({ resource: 'user', action: AuthActionVerb.WRITE })
  async createUser() {
    // 需要 'user:write' 权限
  }
}
```

#### 5.3.2 权限验证流程

1. 用户发起请求，携带 JWT Token
2. `AuthZGuard` 拦截请求，验证 Token
3. 从 Token 中提取用户信息（userId, domain, roles）
4. 查询用户角色（优先从 Redis 缓存获取）
5. 使用 Casbin 验证权限：`enforcer.enforce(roleCode, resource, action, domain)`
6. 验证通过则继续执行，否则返回 403 Forbidden

### 5.4 权限分配 API

#### 5.4.1 为角色分配权限

```http
POST /authorization/assign-permission
Content-Type: application/json

{
  "domain": "domain001",
  "roleId": "role-id-123",
  "permissions": ["endpoint-id-1", "endpoint-id-2"]
}
```

**业务规则**：

- 验证域和角色的存在性
- 验证权限（API 端点）是否存在
- 同步权限到 Casbin 策略中
- 支持增量更新：删除不再需要的权限，添加新权限

**权限策略同步**：

- 删除策略：`removeFilteredPolicy(0, roleCode, resource, action, domain)`
- 添加策略：`addPermissionForUser(roleCode, resource, action, domain)`

---

## 系统集成

### 6.1 用户-角色关联

#### 6.1.1 为角色分配用户

```http
POST /authorization/assign-users
Content-Type: application/json

{
  "roleId": "role-id-123",
  "userIds": ["user-id-1", "user-id-2"]
}
```

**数据存储**：`sys_user_role` 表

**业务规则**：

- 验证角色和用户的存在性
- 支持增量更新：只添加新用户和删除不再需要的用户
- 使用事务确保数据一致性

#### 6.1.2 用户角色查询

用户登录后，系统会：

1. 查询用户的所有角色代码
2. 将角色代码缓存到 Redis，键格式：`auth:token:{userId}`
3. 缓存过期时间与 JWT Token 过期时间一致

### 6.2 角色-菜单关联

#### 6.2.1 为角色分配菜单

```http
POST /authorization/assign-routes
Content-Type: application/json

{
  "domain": "domain001",
  "roleId": "role-id-123",
  "routeIds": [1, 2, 3]
}
```

**数据存储**：`sys_role_menu` 表（包含 `domain` 字段，支持多租户隔离）

**业务规则**：

- 验证域、角色和菜单的存在性
- 支持增量更新
- 使用事务确保数据一致性

#### 6.2.2 用户菜单查询

根据用户角色查询可访问的菜单：

```typescript
// 查询用户可访问的菜单
const menus = await menuService.getUserRoutes(roleCodes, domain);
// 返回树形结构的菜单数组
```

### 6.3 角色-权限关联

角色权限存储在 Casbin 中，格式为：

```
p, admin, user, read, domain001, allow
p, admin, user, write, domain001, allow
p, admin, role, read, domain001, allow
```

**权限验证**：

```typescript
// 验证用户是否有权限
const hasPermission = await enforcer.enforce(
  roleCode, // 角色代码
  'user', // 资源
  'read', // 操作
  'domain001', // 域
);
```

---

## 使用指南

### 7.1 完整权限配置流程

#### 步骤 1：创建角色

```http
POST /role
{
  "code": "business_manager",
  "name": "业务管理员",
  "pid": "0",
  "status": "ENABLED",
  "description": "业务管理员角色"
}
```

#### 步骤 2：创建菜单

```http
POST /route
{
  "menuName": "订单管理",
  "menuType": "MENU",
  "routeName": "order-management",
  "routePath": "/order",
  "component": "OrderManagement",
  "pid": 0,
  "order": 1,
  "constant": false,
  "status": "ENABLED"
}
```

#### 步骤 3：为角色分配权限

```http
POST /authorization/assign-permission
{
  "domain": "domain001",
  "roleId": "role-id-123",
  "permissions": ["endpoint-id-1", "endpoint-id-2"]
}
```

#### 步骤 4：为角色分配菜单

```http
POST /authorization/assign-routes
{
  "domain": "domain001",
  "roleId": "role-id-123",
  "routeIds": [1, 2, 3]
}
```

#### 步骤 5：为用户分配角色

```http
POST /authorization/assign-users
{
  "roleId": "role-id-123",
  "userIds": ["user-id-1"]
}
```

### 7.2 前端集成

#### 7.2.1 获取用户路由

```typescript
// 用户登录后获取可访问的路由
const response = await fetch('/authorization/getUserRoutes', {
  headers: {
    Authorization: `Bearer ${token}`,
  },
});

const { routes, home } = await response.json();
// routes: 路由树结构
// home: 首页路径
```

#### 7.2.2 路由守卫

```typescript
// 前端路由守卫示例
router.beforeEach((to, from, next) => {
  const userRoutes = store.getters.userRoutes;
  const hasRoute = checkRouteAccess(to.path, userRoutes);

  if (hasRoute) {
    next();
  } else {
    next('/403'); // 无权限页面
  }
});
```

### 7.3 后端权限验证

#### 7.3.1 控制器权限声明

```typescript
@Controller('user')
@UseGuards(AuthZGuard)
export class UserController {
  @Get()
  @UsePermissions({ resource: 'user', action: AuthActionVerb.READ })
  async getUsers() {
    // 需要 'user:read' 权限
  }
}
```

#### 7.3.2 动态权限验证

```typescript
// 在服务中动态验证权限
const hasPermission = await this.authZRBACService.enforcer.enforce(
  roleCode,
  'user',
  'read',
  domain,
);

if (!hasPermission) {
  throw new ForbiddenException('Insufficient permissions');
}
```

---

## 最佳实践

### 8.1 角色设计建议

1. **角色命名规范**：
   - 使用有意义的角色代码，如 `admin`、`business_manager`、`operator`
   - 避免使用特殊字符和空格
   - 建议使用小写字母、数字和下划线

2. **角色层级设计**：
   - 建议控制角色层级深度在 3-4 层
   - 避免过深的层级结构，以提升查询性能
   - 设计时考虑权限继承的清晰性和可维护性

3. **角色状态管理**：
   - 使用 `ENABLED` 和 `DISABLED` 状态控制角色的可用性
   - 禁用角色时，用户将无法使用该角色的权限

### 8.2 菜单设计建议

1. **菜单结构**：
   - 使用 DIRECTORY 类型组织菜单层级
   - 使用 MENU 类型表示可访问的路由
   - 使用 BUTTON 类型控制页面内操作权限

2. **常量路由**：
   - 将系统公共页面设置为常量路由（如登录页、错误页）
   - 常量路由不受权限控制，所有用户都可以访问

3. **菜单排序**：
   - 使用 `order` 字段控制菜单显示顺序
   - 数字越小越靠前
   - 每个层级的菜单独立排序

### 8.3 权限设计建议

1. **权限粒度**：
   - 使用资源:操作格式定义权限（如 `user:read`、`user:write`）
   - 支持细粒度的权限控制

2. **权限分配**：
   - 通过角色分配权限，而不是直接分配给用户
   - 支持多角色，用户拥有所有角色的权限并集

3. **多租户隔离**：
   - 所有权限分配必须指定域（domain）
   - 确保不同租户之间的权限隔离

### 8.4 性能优化

1. **Redis 缓存**：
   - 用户角色信息缓存到 Redis，提升权限验证性能
   - 缓存键格式：`auth:token:{userId}`
   - 缓存过期时间与 JWT Token 过期时间一致

2. **数据库查询**：
   - 使用索引优化查询性能（角色代码、用户 ID 等）
   - 批量查询使用 `IN` 查询而非循环查询
   - 分页查询使用 `LIMIT` 和 `OFFSET`

3. **Casbin 策略**：
   - 定期清理无效的权限策略
   - 使用 `getFilteredPolicy` 查询特定角色的权限

### 8.5 安全注意事项

1. **密码安全**：
   - 用户密码使用 bcrypt 加密存储
   - 密码值对象确保密码不可直接访问

2. **令牌安全**：
   - JWT 令牌使用强密钥签名
   - 刷新令牌使用独立的密钥
   - 令牌过期时间应合理设置

3. **权限验证**：
   - 所有需要权限的接口必须使用 `@UsePermissions` 装饰器
   - 使用 `AuthZGuard` 确保权限验证执行
   - 删除角色时自动清理相关权限策略

### 8.6 数据一致性

1. **事务管理**：
   - 角色分配操作使用事务确保数据一致性
   - 删除操作前检查关联数据

2. **事件驱动**：
   - 使用领域事件实现模块间解耦
   - 删除角色时自动清理权限策略和菜单关联

3. **级联删除**：
   - 删除角色前应确保角色下没有关联的用户
   - 删除菜单前必须确保菜单下没有子菜单

---

## 附录

### A. 数据库表结构

#### sys_role（角色表）

```sql
CREATE TABLE "sys_role" (
  "id" varchar(255) NOT NULL,
  "code" varchar(255) NOT NULL,
  "name" varchar(255) NOT NULL,
  "pid" varchar(255) NOT NULL,
  "status" varchar(255) NOT NULL,
  "description" varchar(255) NULL,
  "created_at" timestamptz NOT NULL,
  "created_by" varchar(255) NOT NULL,
  "updated_at" varchar(255) NULL,
  "updated_by" varchar(255) NULL,
  CONSTRAINT "sys_role_pkey" PRIMARY KEY ("id")
);
```

#### sys_menu（菜单表）

```sql
CREATE TABLE "sys_menu" (
  "id" serial PRIMARY KEY,
  "menu_type" varchar(255) NOT NULL,
  "menu_name" varchar(255) NOT NULL,
  "route_name" varchar(255) NOT NULL,
  "route_path" varchar(255) NOT NULL,
  "component" varchar(255) NOT NULL,
  "status" varchar(255) NOT NULL,
  "pid" int NOT NULL,
  "order" int NOT NULL,
  "constant" boolean NOT NULL,
  "icon_type" int NULL,
  "icon" varchar(255) NULL,
  "path_param" varchar(255) NULL,
  "active_menu" varchar(255) NULL,
  "hide_in_menu" boolean NULL,
  "i18n_key" varchar(255) NULL,
  "keep_alive" boolean NULL,
  "href" varchar(255) NULL,
  "multi_tab" boolean NULL,
  "created_at" timestamptz NOT NULL,
  "created_by" varchar(255) NOT NULL,
  "updated_at" varchar(255) NULL,
  "updated_by" varchar(255) NULL
);
```

#### sys_user_role（用户角色关联表）

```sql
CREATE TABLE "sys_user_role" (
  "id" varchar(255) NOT NULL,
  "role_id" varchar(255) NOT NULL,
  "user_id" varchar(255) NOT NULL,
  CONSTRAINT "sys_user_role_pkey" PRIMARY KEY ("id")
);
```

#### sys_role_menu（角色菜单关联表）

```sql
CREATE TABLE "sys_role_menu" (
  "id" varchar(255) NOT NULL,
  "role_id" varchar(255) NOT NULL,
  "menu_id" int NOT NULL,
  "domain" varchar(255) NOT NULL,
  CONSTRAINT "sys_role_menu_pkey" PRIMARY KEY ("id")
);
```

#### sys_endpoint（API 端点表）

```sql
CREATE TABLE "sys_endpoint" (
  "id" varchar(255) NOT NULL,
  "path" varchar(255) NOT NULL,
  "method" varchar(255) NOT NULL,
  "action" varchar(255) NOT NULL,
  "resource" varchar(255) NOT NULL,
  "controller" varchar(255) NOT NULL,
  "summary" varchar(255) NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" varchar(255) NULL,
  CONSTRAINT "sys_endpoint_pkey" PRIMARY KEY ("id")
);
```

### B. Casbin 模型配置

```ini
[request_definition]
r = sub, obj, act, dom

[policy_definition]
p = sub, obj, act, dom, eft

[role_definition]
g = _, _, _

[policy_effect]
e = some(where (p.eft == allow))

[matchers]
m = g(r.sub, p.sub, r.dom) && r.obj == p.obj && r.act == p.act && r.dom == p.dom
```

### C. 常用 API 端点

| 端点                               | 方法   | 说明             |
| ---------------------------------- | ------ | ---------------- |
| `/role`                            | GET    | 分页查询角色列表 |
| `/role`                            | POST   | 创建角色         |
| `/role`                            | PUT    | 更新角色         |
| `/role/{id}`                       | DELETE | 删除角色         |
| `/route`                           | GET    | 获取所有菜单列表 |
| `/route/tree`                      | GET    | 获取菜单树       |
| `/route`                           | POST   | 创建菜单         |
| `/route`                           | PUT    | 更新菜单         |
| `/route/{id}`                      | DELETE | 删除菜单         |
| `/authorization/assign-permission` | POST   | 为角色分配权限   |
| `/authorization/assign-routes`     | POST   | 为角色分配菜单   |
| `/authorization/assign-users`      | POST   | 为角色分配用户   |
| `/authorization/getUserRoutes`     | GET    | 获取用户路由     |

---

**文档版本**：v1.0.0  
**最后更新**：2024-12-XX  
**维护者**：IAM 团队
