# IAM-API æ¶æ„è®¾è®¡æ–‡æ¡£

## æ¦‚è¿°

`iam-api` æ˜¯ä¸€ä¸ªåŸºäº **é¢†åŸŸé©±åŠ¨è®¾è®¡ (DDD)**ã€**CQRS** å’Œ **å…­è¾¹å½¢æ¶æ„** çš„ NestJS åº”ç”¨ï¼Œç”¨äºæä¾›èº«ä»½è®¤è¯ä¸æˆæƒç®¡ç† (IAM) æœåŠ¡ã€‚

> ğŸ“– **ç›¸å…³æ–‡æ¡£**ï¼šå¦‚éœ€äº†è§£å½“å‰æ¶æ„ä¸ Clean Architecture çš„åŒºåˆ«ï¼Œè¯·å‚é˜… [æ¶æ„å¯¹æ¯”æ–‡æ¡£](./ARCHITECTURE_COMPARISON.md)

## æ ¸å¿ƒæ¶æ„æ¨¡å¼

### 1. é¢†åŸŸé©±åŠ¨è®¾è®¡ (Domain-Driven Design, DDD)

é¡¹ç›®é‡‡ç”¨ DDD çš„ **æœ‰ç•Œä¸Šä¸‹æ–‡ (Bounded Context)** æ¨¡å¼ï¼Œå°†ä¸šåŠ¡é¢†åŸŸåˆ’åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„ä¸Šä¸‹æ–‡ï¼š

```
src/lib/bounded-contexts/
â”œâ”€â”€ iam/                    # èº«ä»½è®¤è¯ä¸æˆæƒä¸Šä¸‹æ–‡
â”‚   â”œâ”€â”€ authentication/     # ç”¨æˆ·è®¤è¯
â”‚   â”œâ”€â”€ domain/             # åŸŸç®¡ç†
â”‚   â”œâ”€â”€ menu/               # èœå•ç®¡ç†
â”‚   â”œâ”€â”€ role/               # è§’è‰²ç®¡ç†
â”‚   â””â”€â”€ tokens/             # ä»¤ç‰Œç®¡ç†
â”œâ”€â”€ access-key/             # è®¿é—®å¯†é’¥ä¸Šä¸‹æ–‡
â”œâ”€â”€ api-endpoint/           # API ç«¯ç‚¹ä¸Šä¸‹æ–‡
â””â”€â”€ log-audit/              # å®¡è®¡æ—¥å¿—ä¸Šä¸‹æ–‡
    â”œâ”€â”€ login-log/          # ç™»å½•æ—¥å¿—
    â””â”€â”€ operation-log/      # æ“ä½œæ—¥å¿—
```

æ¯ä¸ªæœ‰ç•Œä¸Šä¸‹æ–‡éƒ½æ˜¯ç‹¬ç«‹çš„ä¸šåŠ¡é¢†åŸŸï¼Œæ‹¥æœ‰è‡ªå·±çš„ï¼š

- **é¢†åŸŸæ¨¡å‹** (Domain Models)
- **åº”ç”¨æœåŠ¡** (Application Services)
- **å‘½ä»¤/æŸ¥è¯¢** (Commands/Queries)
- **ç«¯å£æ¥å£** (Ports)

### 2. CQRS (Command Query Responsibility Segregation)

é¡¹ç›®ä¸¥æ ¼éµå¾ª CQRS æ¨¡å¼ï¼Œå°†**å†™æ“ä½œ**ï¼ˆå‘½ä»¤ï¼‰å’Œ**è¯»æ“ä½œ**ï¼ˆæŸ¥è¯¢ï¼‰å®Œå…¨åˆ†ç¦»ï¼š

#### å‘½ä»¤ (Commands) - å†™æ“ä½œ

- ä½ç½®ï¼š`src/lib/bounded-contexts/{context}/commands/`
- ç¤ºä¾‹ï¼š`UserCreateCommand`, `UserUpdateCommand`, `UserDeleteCommand`
- å¤„ç†ï¼šé€šè¿‡ `CommandHandler` å¤„ç†ï¼Œä¿®æ”¹é¢†åŸŸçŠ¶æ€

#### æŸ¥è¯¢ (Queries) - è¯»æ“ä½œ

- ä½ç½®ï¼š`src/lib/bounded-contexts/{context}/queries/`
- ç¤ºä¾‹ï¼š`PageUsersQuery`, `FindUserByIdQuery`
- å¤„ç†ï¼šé€šè¿‡ `QueryHandler` å¤„ç†ï¼Œåªè¯»å–æ•°æ®ï¼Œä¸ä¿®æ”¹çŠ¶æ€

#### å‘½ä»¤/æŸ¥è¯¢å¤„ç†å™¨

- ä½ç½®ï¼š`src/lib/bounded-contexts/{context}/application/command-handlers/` æˆ– `query-handlers/`
- èŒè´£ï¼šæ‰§è¡Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘

### 3. å…­è¾¹å½¢æ¶æ„ (Hexagonal Architecture)

é¡¹ç›®é‡‡ç”¨**ç«¯å£å’Œé€‚é…å™¨æ¨¡å¼**ï¼Œå°†æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸å¤–éƒ¨ä¾èµ–è§£è€¦ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Application)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        é¢†åŸŸå±‚ (Domain)            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ å®ä½“     â”‚    â”‚ å€¼å¯¹è±¡   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ èšåˆæ ¹   â”‚    â”‚ é¢†åŸŸäº‹ä»¶ â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        ç«¯å£ (Ports)               â”‚  â”‚
â”‚  â”‚  - Repository æ¥å£                â”‚  â”‚
â”‚  â”‚  - Service æ¥å£                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• ä¾èµ–æ³¨å…¥
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      é€‚é…å™¨ (Adapters)            â”‚  â”‚
â”‚  â”‚  - Repository å®ç° (MikroORM)    â”‚  â”‚
â”‚  â”‚  - å¤–éƒ¨æœåŠ¡é€‚é…å™¨                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é¡¹ç›®ç»“æ„

### ç›®å½•å±‚æ¬¡

```
apps/iam-api/src/
â”œâ”€â”€ api/                          # æ¥å£å±‚ (Presentation Layer)
â”‚   â”œâ”€â”€ iam/                      # IAM ç›¸å…³ REST API
â”‚   â”‚   â”œâ”€â”€ rest/                 # REST æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ dto/                  # æ•°æ®ä¼ è¾“å¯¹è±¡
â”‚   â”œâ”€â”€ access-key/                # è®¿é—®å¯†é’¥ API
â”‚   â”œâ”€â”€ endpoint/                  # API ç«¯ç‚¹ API
â”‚   â””â”€â”€ log-audit/                 # å®¡è®¡æ—¥å¿— API
â”‚
â”œâ”€â”€ lib/                           # ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)
â”‚   â”œâ”€â”€ bounded-contexts/          # æœ‰ç•Œä¸Šä¸‹æ–‡
â”‚   â”‚   â”œâ”€â”€ iam/                   # IAM ä¸Šä¸‹æ–‡
â”‚   â”‚   â”‚   â”œâ”€â”€ authentication/   # è®¤è¯å­ä¸Šä¸‹æ–‡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ application/   # åº”ç”¨å±‚
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ command-handlers/  # å‘½ä»¤å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ query-handlers/    # æŸ¥è¯¢å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ event-handlers/    # äº‹ä»¶å¤„ç†å™¨
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ service/           # åº”ç”¨æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ commands/              # å‘½ä»¤å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ queries/               # æŸ¥è¯¢å®šä¹‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ domain/                # é¢†åŸŸå±‚
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.ts            # ç”¨æˆ·èšåˆæ ¹
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.read.model.ts # ç”¨æˆ·è¯»æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ password.value-object.ts # å¯†ç å€¼å¯¹è±¡
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ events/            # é¢†åŸŸäº‹ä»¶
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ports/                 # ç«¯å£æ¥å£
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ user.read.repo-port.ts   # è¯»ä»“å‚¨æ¥å£
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ user.write.repo-port.ts  # å†™ä»“å‚¨æ¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ domain/            # åŸŸç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ menu/              # èœå•ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ role/              # è§’è‰²ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ tokens/            # ä»¤ç‰Œç®¡ç†
â”‚   â”‚   â”œâ”€â”€ access-key/            # è®¿é—®å¯†é’¥ä¸Šä¸‹æ–‡
â”‚   â”‚   â”œâ”€â”€ api-endpoint/         # API ç«¯ç‚¹ä¸Šä¸‹æ–‡
â”‚   â”‚   â””â”€â”€ log-audit/            # å®¡è®¡æ—¥å¿—ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ shared/                    # å…±äº«èµ„æº
â”‚       â”œâ”€â”€ enums/                # æšä¸¾å®šä¹‰
â”‚       â””â”€â”€ constants/            # å¸¸é‡å®šä¹‰
â”‚
â”œâ”€â”€ infra/                         # åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)
â”‚   â””â”€â”€ bounded-contexts/          # åŸºç¡€è®¾æ–½å®ç°
â”‚       â”œâ”€â”€ iam/                   # IAM åŸºç¡€è®¾æ–½
â”‚       â”‚   â”œâ”€â”€ authentication/   # è®¤è¯åŸºç¡€è®¾æ–½
â”‚       â”‚   â”‚   â”œâ”€â”€ repository/   # ä»“å‚¨å®ç°
â”‚       â”‚   â”‚   â”‚   â”œâ”€â”€ user.read.pg.repository.ts   # è¯»ä»“å‚¨å®ç°
â”‚       â”‚   â”‚   â”‚   â””â”€â”€ user.write.pg.repository.ts  # å†™ä»“å‚¨å®ç°
â”‚       â”‚   â”‚   â””â”€â”€ iam.module.ts # æ¨¡å—é…ç½®
â”‚       â”‚   â”œâ”€â”€ domain/            # åŸŸåŸºç¡€è®¾æ–½
â”‚       â”‚   â”œâ”€â”€ menu/              # èœå•åŸºç¡€è®¾æ–½
â”‚       â”‚   â”œâ”€â”€ role/              # è§’è‰²åŸºç¡€è®¾æ–½
â”‚       â”‚   â””â”€â”€ tokens/            # ä»¤ç‰ŒåŸºç¡€è®¾æ–½
â”‚       â”œâ”€â”€ access-key/            # è®¿é—®å¯†é’¥åŸºç¡€è®¾æ–½
â”‚       â”œâ”€â”€ api-endpoint/          # API ç«¯ç‚¹åŸºç¡€è®¾æ–½
â”‚       â””â”€â”€ log-audit/             # å®¡è®¡æ—¥å¿—åŸºç¡€è®¾æ–½
â”‚
â”œâ”€â”€ app.module.ts                  # æ ¹æ¨¡å—
â”œâ”€â”€ main.ts                         # åº”ç”¨å…¥å£
â””â”€â”€ resources/                      # é™æ€èµ„æº
```

## æ¶æ„å±‚æ¬¡è¯¦è§£

### 1. æ¥å£å±‚ (API Layer) - `src/api/`

**èŒè´£**ï¼š

- æ¥æ”¶ HTTP è¯·æ±‚
- å‚æ•°éªŒè¯å’Œè½¬æ¢ (DTO)
- è°ƒç”¨ CQRS çš„ CommandBus/QueryBus
- è¿”å› HTTP å“åº”

**ç‰¹ç‚¹**ï¼š

- ä½¿ç”¨ NestJS çš„ `@Controller` è£…é¥°å™¨
- é€šè¿‡ `CommandBus` å’Œ `QueryBus` ä¸ä¸šåŠ¡å±‚äº¤äº’
- ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘ï¼Œåªè´Ÿè´£åè®®è½¬æ¢

**ç¤ºä¾‹**ï¼š

```typescript
@Controller('user')
export class UserController {
  constructor(
    private readonly queryBus: QueryBus,
    private readonly commandBus: CommandBus,
  ) {}

  @Post()
  async create(@Body() dto: UserCreateDto) {
    const command = new UserCreateCommand(dto);
    await this.commandBus.execute(command);
  }
}
```

### 2. ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer) - `src/lib/`

#### 2.1 åº”ç”¨å±‚ (Application Layer)

**ä½ç½®**ï¼š`src/lib/bounded-contexts/{context}/application/`

**èŒè´£**ï¼š

- ç¼–æ’é¢†åŸŸå¯¹è±¡å®Œæˆä¸šåŠ¡ç”¨ä¾‹
- å¤„ç†å‘½ä»¤å’ŒæŸ¥è¯¢
- åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡
- äº‹åŠ¡ç®¡ç†

**ç»„ä»¶**ï¼š

- **Command Handlers** (`command-handlers/`)
  - å¤„ç†å†™æ“ä½œå‘½ä»¤
  - ä¿®æ”¹é¢†åŸŸçŠ¶æ€
  - å‘å¸ƒé¢†åŸŸäº‹ä»¶

- **Query Handlers** (`query-handlers/`)
  - å¤„ç†è¯»æ“ä½œæŸ¥è¯¢
  - ä»è¯»æ¨¡å‹è·å–æ•°æ®
  - ä¸ä¿®æ”¹çŠ¶æ€

- **Event Handlers** (`event-handlers/`)
  - å¤„ç†é¢†åŸŸäº‹ä»¶
  - å®ç°è·¨ä¸Šä¸‹æ–‡é€šä¿¡
  - æ‰§è¡Œå‰¯ä½œç”¨ï¼ˆå¦‚å‘é€é‚®ä»¶ã€è®°å½•æ—¥å¿—ï¼‰

- **Application Services** (`service/`)
  - å¤æ‚çš„ä¸šåŠ¡ç”¨ä¾‹ç¼–æ’
  - è·¨èšåˆåè°ƒ

#### 2.2 é¢†åŸŸå±‚ (Domain Layer)

**ä½ç½®**ï¼š`src/lib/bounded-contexts/{context}/domain/`

**èŒè´£**ï¼š

- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- ä¸šåŠ¡è§„åˆ™å’Œçº¦æŸ
- é¢†åŸŸæ¨¡å‹å®šä¹‰

**ç»„ä»¶**ï¼š

- **èšåˆæ ¹ (Aggregate Root)**

  ```typescript
  export class User extends AggregateRoot {
    // é¢†åŸŸé€»è¾‘
    async loginUser(password: string) { ... }
    async verifyPassword(password: string) { ... }

    // å‘å¸ƒé¢†åŸŸäº‹ä»¶
    async created() {
      this.apply(new UserCreatedEvent(...));
    }
  }
  ```

- **å€¼å¯¹è±¡ (Value Objects)**

  ```typescript
  export class Password {
    // å°è£…å¯†ç ç›¸å…³é€»è¾‘
    static async hash(plain: string): Promise<Password> { ... }
    compare(plain: string): Promise<boolean> { ... }
  }
  ```

- **é¢†åŸŸäº‹ä»¶ (Domain Events)**

  ```typescript
  export class UserCreatedEvent {
    constructor(
      public readonly userId: string,
      public readonly username: string,
      public readonly domain: string,
    ) {}
  }
  ```

- **è¯»æ¨¡å‹ (Read Models)**
  - ç”¨äºæŸ¥è¯¢çš„åªè¯»æ•°æ®æ¨¡å‹
  - é€šå¸¸å¯¹åº”æ•°æ®åº“è§†å›¾æˆ–æŸ¥è¯¢ä¼˜åŒ–åçš„ç»“æ„

#### 2.3 ç«¯å£å±‚ (Ports Layer)

**ä½ç½®**ï¼š`src/lib/bounded-contexts/{context}/ports/`

**èŒè´£**ï¼š

- å®šä¹‰ä»“å‚¨æ¥å£
- å®šä¹‰æœåŠ¡æ¥å£
- å®šä¹‰å¤–éƒ¨ä¾èµ–å¥‘çº¦

**ç¤ºä¾‹**ï¼š

```typescript
export interface UserReadRepoPort {
  findUserById(id: string): Promise<UserProperties | null>;
  pageUsers(query: PageUsersQuery): Promise<PaginationResult<UserProperties>>;
  // ... å…¶ä»–æŸ¥è¯¢æ–¹æ³•
}

export interface UserWriteRepoPort {
  save(user: User): Promise<void>;
  delete(id: string): Promise<void>;
  // ... å…¶ä»–å†™æ“ä½œæ–¹æ³•
}
```

### 3. åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer) - `src/infra/`

**èŒè´£**ï¼š

- å®ç°ç«¯å£æ¥å£
- ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’
- æŠ€æœ¯ç»†èŠ‚å®ç°

**ç»„ä»¶**ï¼š

- **ä»“å‚¨å®ç° (Repository Implementations)**

  ```typescript
  @Injectable()
  export class UserReadRepository implements UserReadRepoPort {
    constructor(private readonly em: EntityManager) {}

    async findUserById(id: string) {
      return await this.em.findOne('SysUser', { id });
    }
  }
  ```

- **æ¨¡å—é…ç½® (Module Configuration)**
  - ä¾èµ–æ³¨å…¥é…ç½®
  - ç«¯å£ä¸é€‚é…å™¨çš„ç»‘å®š
  - å¤–éƒ¨æœåŠ¡é›†æˆ

## æ•°æ®æµ

### å†™æ“ä½œæµç¨‹ (Command Flow)

```
1. HTTP Request
   â†“
2. Controller (API Layer)
   - æ¥æ”¶ DTO
   - éªŒè¯å‚æ•°
   â†“
3. CommandBus
   - è·¯ç”±åˆ°å¯¹åº”çš„ CommandHandler
   â†“
4. CommandHandler (Application Layer)
   - ä» Repository åŠ è½½èšåˆ
   - è°ƒç”¨é¢†åŸŸæ–¹æ³•
   - ä¿å­˜èšåˆ
   â†“
5. Repository (Infrastructure Layer)
   - ä½¿ç”¨ MikroORM æŒä¹…åŒ–
   â†“
6. Domain Event
   - èšåˆå‘å¸ƒäº‹ä»¶
   â†“
7. EventHandler (Application Layer)
   - å¤„ç†å‰¯ä½œç”¨ï¼ˆæ—¥å¿—ã€é€šçŸ¥ç­‰ï¼‰
```

### è¯»æ“ä½œæµç¨‹ (Query Flow)

```
1. HTTP Request
   â†“
2. Controller (API Layer)
   - æ¥æ”¶æŸ¥è¯¢å‚æ•°
   â†“
3. QueryBus
   - è·¯ç”±åˆ°å¯¹åº”çš„ QueryHandler
   â†“
4. QueryHandler (Application Layer)
   - è°ƒç”¨ ReadRepository
   â†“
5. ReadRepository (Infrastructure Layer)
   - ä½¿ç”¨ MikroORM æŸ¥è¯¢
   - è¿”å›è¯»æ¨¡å‹
   â†“
6. Response
   - è¿”å›æŸ¥è¯¢ç»“æœ
```

## ä¾èµ–å…³ç³»

### ä¾èµ–æ–¹å‘

```
API Layer
   â†“ (ä¾èµ–)
Application Layer
   â†“ (ä¾èµ–)
Domain Layer
   â†‘ (å®ç°)
Infrastructure Layer
```

**åŸåˆ™**ï¼š

- **ä¾èµ–å€’ç½®**ï¼šé¢†åŸŸå±‚å®šä¹‰æ¥å£ï¼ŒåŸºç¡€è®¾æ–½å±‚å®ç°æ¥å£
- **å•å‘ä¾èµ–**ï¼šå†…å±‚ä¸ä¾èµ–å¤–å±‚
- **æ¥å£éš”ç¦»**ï¼šé€šè¿‡ç«¯å£æ¥å£è§£è€¦

### æ¨¡å—ä¾èµ–

```
AppModule
   â†“
ApiModule
   â†“
InfraModule (å„ä¸ªä¸Šä¸‹æ–‡çš„åŸºç¡€è®¾æ–½æ¨¡å—)
   â†“
ApplicationModule (å„ä¸ªä¸Šä¸‹æ–‡çš„åº”ç”¨æ¨¡å—)
   â†“
Domain (é¢†åŸŸæ¨¡å‹ï¼Œæ— ä¾èµ–)
```

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶

- **NestJS**: åº”ç”¨æ¡†æ¶
- **Fastify**: HTTP æœåŠ¡å™¨
- **MikroORM**: ORM æ¡†æ¶ï¼ˆæ›¿ä»£ Prismaï¼‰
- **TypeScript**: å¼€å‘è¯­è¨€

### CQRS æ”¯æŒ

- **@nestjs/cqrs**: CQRS æ¨¡å¼å®ç°
- **CommandBus/QueryBus**: å‘½ä»¤å’ŒæŸ¥è¯¢æ€»çº¿

### è®¤è¯æˆæƒ

- **JWT**: èº«ä»½è®¤è¯
- **Casbin**: åŸºäº RBAC çš„æˆæƒ
- **@hl8/casbin**: Casbin é›†æˆæ¨¡å—

### å…¶ä»–

- **Redis**: ç¼“å­˜å’Œé™æµ
- **Swagger**: API æ–‡æ¡£
- **Class Validator**: å‚æ•°éªŒè¯

## è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)

- æ¯ä¸ªç±»/æ¨¡å—åªè´Ÿè´£ä¸€ä¸ªèŒè´£
- CommandHandler åªå¤„ç†å‘½ä»¤
- QueryHandler åªå¤„ç†æŸ¥è¯¢

### 2. å¼€é—­åŸåˆ™ (OCP)

- é€šè¿‡ç«¯å£æ¥å£æ‰©å±•åŠŸèƒ½
- æ–°å¢ä»“å‚¨å®ç°æ— éœ€ä¿®æ”¹ä¸šåŠ¡é€»è¾‘

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

- ä¸šåŠ¡å±‚ä¾èµ–æŠ½è±¡ï¼ˆç«¯å£ï¼‰
- åŸºç¡€è®¾æ–½å±‚å®ç°å…·ä½“ç»†èŠ‚

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)

- è¯»ä»“å‚¨å’Œå†™ä»“å‚¨åˆ†ç¦»
- ä¸åŒæŸ¥è¯¢åœºæ™¯ä½¿ç”¨ä¸åŒæ¥å£

### 5. é¢†åŸŸé©±åŠ¨è®¾è®¡åŸåˆ™

- èšåˆæ ¹ä¿æŠ¤ä¸šåŠ¡ä¸å˜é‡
- é¢†åŸŸäº‹ä»¶å®ç°è·¨ä¸Šä¸‹æ–‡é€šä¿¡
- æœ‰ç•Œä¸Šä¸‹æ–‡éš”ç¦»ä¸åŒä¸šåŠ¡é¢†åŸŸ

## æœ€ä½³å®è·µ

### 1. å‘½ä»¤è®¾è®¡

- å‘½ä»¤åº”è¯¥æ˜¯ä¸å¯å˜çš„
- å‘½ä»¤åŒ…å«æ‰§è¡Œæ“ä½œæ‰€éœ€çš„æ‰€æœ‰ä¿¡æ¯
- å‘½ä»¤åç§°ä½¿ç”¨åŠ¨è¯ï¼š`CreateUser`, `UpdateUser`, `DeleteUser`

### 2. æŸ¥è¯¢è®¾è®¡

- æŸ¥è¯¢ä¸ä¿®æ”¹çŠ¶æ€
- æŸ¥è¯¢å¯ä»¥è¿”å›è¯»æ¨¡å‹æˆ– DTO
- å¤æ‚æŸ¥è¯¢ä½¿ç”¨ä¸“é—¨çš„ QueryHandler

### 3. é¢†åŸŸäº‹ä»¶

- äº‹ä»¶åç§°ä½¿ç”¨è¿‡å»æ—¶ï¼š`UserCreated`, `UserDeleted`
- äº‹ä»¶åŒ…å«è¶³å¤Ÿçš„ä¿¡æ¯ä¾›å¤„ç†å™¨ä½¿ç”¨
- äº‹ä»¶å¤„ç†å™¨åº”è¯¥æ˜¯å¹‚ç­‰çš„

### 4. ä»“å‚¨è®¾è®¡

- è¯»ä»“å‚¨å’Œå†™ä»“å‚¨åˆ†ç¦»ï¼ˆCQRSï¼‰
- è¯»ä»“å‚¨è¿”å›è¯»æ¨¡å‹
- å†™ä»“å‚¨æ“ä½œèšåˆæ ¹

### 5. æ¨¡å—ç»„ç»‡

- æ¯ä¸ªæœ‰ç•Œä¸Šä¸‹æ–‡æœ‰ç‹¬ç«‹çš„æ¨¡å—
- åŸºç¡€è®¾æ–½æ¨¡å—è´Ÿè´£ä¾èµ–æ³¨å…¥é…ç½®
- åº”ç”¨æ¨¡å—åŒ…å«ä¸šåŠ¡é€»è¾‘

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„æœ‰ç•Œä¸Šä¸‹æ–‡

1. **åˆ›å»ºé¢†åŸŸæ¨¡å‹** (`src/lib/bounded-contexts/{new-context}/domain/`)
2. **å®šä¹‰ç«¯å£æ¥å£** (`src/lib/bounded-contexts/{new-context}/ports/`)
3. **å®ç°åº”ç”¨æœåŠ¡** (`src/lib/bounded-contexts/{new-context}/application/`)
4. **å®ç°åŸºç¡€è®¾æ–½** (`src/infra/bounded-contexts/{new-context}/`)
5. **åˆ›å»º REST API** (`src/api/{new-context}/`)
6. **æ³¨å†Œæ¨¡å—** (`src/api/api.module.ts`)

### æ·»åŠ æ–°çš„å‘½ä»¤/æŸ¥è¯¢

1. **å®šä¹‰å‘½ä»¤/æŸ¥è¯¢** (`commands/` æˆ– `queries/`)
2. **åˆ›å»ºå¤„ç†å™¨** (`application/command-handlers/` æˆ– `query-handlers/`)
3. **åœ¨ Controller ä¸­ä½¿ç”¨** (`api/{context}/rest/`)

## æ€»ç»“

`iam-api` é‡‡ç”¨äº†ç°ä»£åŒ–çš„ä¼ä¸šçº§æ¶æ„æ¨¡å¼ï¼Œé€šè¿‡ **DDD**ã€**CQRS** å’Œ **å…­è¾¹å½¢æ¶æ„** å®ç°äº†ï¼š

- âœ… **æ¸…æ™°çš„èŒè´£åˆ†ç¦»**ï¼šæ¥å£å±‚ã€åº”ç”¨å±‚ã€é¢†åŸŸå±‚ã€åŸºç¡€è®¾æ–½å±‚å„å¸å…¶èŒ
- âœ… **é«˜å¯æµ‹è¯•æ€§**ï¼šé€šè¿‡ç«¯å£æ¥å£ï¼Œå¯ä»¥è½»æ¾æ¨¡æ‹Ÿå¤–éƒ¨ä¾èµ–
- âœ… **é«˜å¯æ‰©å±•æ€§**ï¼šæ–°å¢åŠŸèƒ½ä¸å½±å“ç°æœ‰ä»£ç 
- âœ… **ä¸šåŠ¡é€»è¾‘é›†ä¸­**ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘é›†ä¸­åœ¨é¢†åŸŸå±‚ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- âœ… **æŠ€æœ¯æ— å…³æ€§**ï¼šé¢†åŸŸå±‚ä¸ä¾èµ–å…·ä½“æŠ€æœ¯å®ç°

è¿™ç§æ¶æ„ç‰¹åˆ«é€‚åˆï¼š

- å¤æ‚çš„ä¸šåŠ¡é¢†åŸŸ
- éœ€è¦é•¿æœŸç»´æŠ¤çš„ç³»ç»Ÿ
- å›¢é˜Ÿåä½œå¼€å‘
- éœ€è¦é«˜å¯æµ‹è¯•æ€§çš„é¡¹ç›®
